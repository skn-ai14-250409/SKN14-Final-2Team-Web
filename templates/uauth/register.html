{% extends "scentpick/base.html" %}
{% block title %}회원가입 - ScentPick{% endblock %}
{% block content %}
<style>
.password-toggle-btn {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  color: #6b7280;
  padding: 0;
  display: flex;
  align-items: center;
}
.password-toggle-btn:hover {
  color: #374151;
}
</style>
<div class="auth-container">
  <h2 style="text-align:center;margin-bottom:30px;color:#2d3748;">회원가입</h2>

  {% if errors %}
    <div style="background-color: #fed7d7; border: 1px solid #e53e3e; color: #c53030; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
      <ul style="margin: 0; padding-left: 20px;">
        {% for error in errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="register-form">
    {% csrf_token %}

    <div class="form-group">
      <label>아이디</label>
      <input type="text" name="username" id="username-input" value="{{ form_data.username|default:'' }}" placeholder="아이디를 입력하세요" required>
      <div id="username-feedback" style="margin-top: 5px; font-size: 14px; min-height: 20px;"></div>
    </div>

    <div class="form-group">
      <label>비밀번호</label>
      <div style="position: relative;">
        <input type="password" name="password1" id="password1" placeholder="비밀번호를 입력하세요 (8자 이상)" required>
        <button type="button" id="toggle-password1" class="password-toggle-btn"></button>
      </div>
    </div>

    <div class="form-group">
      <label>비밀번호 확인</label>
      <div style="position: relative;">
        <input type="password" name="password2" id="password2" placeholder="비밀번호를 다시 입력하세요" required>
        <button type="button" id="toggle-password2" class="password-toggle-btn"></button>
      </div>
    </div>

    <div class="form-group">
      <label>이름</label>
      <input type="text" name="name" value="{{ form_data.name|default:'' }}" placeholder="이름을 입력하세요" required>
    </div>

    <div class="form-group">
      <label>이메일</label>
      <input type="email" name="email" id="email-input" value="{{ form_data.email|default:'' }}" placeholder="이메일을 입력하세요 (예: user@example.com)" required pattern="[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}">
      <div id="email-feedback" style="margin-top: 5px; font-size: 14px; min-height: 20px;"></div>
    </div>

    <div class="form-group">
      <label>출생연도</label>
      <input type="number" name="birth_year" value="{{ form_data.birth_year|default:'' }}" min="1900" max="2100" placeholder="예: 1995" required>
    </div>

    <div class="form-group">
      <label>성별</label>
      <div class="gender-selection">
        <button type="button" class="gender-btn {% if form_data.gender == 'Male' %}selected{% endif %}" data-gender="Male">남성</button>
        <button type="button" class="gender-btn {% if form_data.gender == 'Female' %}selected{% endif %}" data-gender="Female">여성</button>
      </div>
      <input type="hidden" name="gender" id="gender-input" value="{{ form_data.gender|default:'' }}" required>
    </div>

    <div class="form-group">
      <label>프로필 사진 (JPG, PNG, GIF, 최대 5MB)</label>
      <input type="file" name="profile_image" id="profile-image" accept="image/jpeg,image/png,image/gif">
      <div id="avatar-editor" style="margin-top:12px; width:300px; height:300px; border-radius:50%; overflow:hidden; border:1px solid #e5e7eb; position:relative; background:#f9fafb; display:none;">
        <img id="avatar-image" alt="preview" style="position:absolute; left:0; top:0; transform-origin: top left; user-select:none; -webkit-user-drag:none;">
      </div>
      <div id="avatar-controls" style="display:none; margin-top:8px;">
        <label style="font-size:12px; color:#6b7280;">확대/축소</label>
        <input type="range" id="avatar-zoom" min="1" max="3" step="0.01" value="1" style="width:300px;">
      </div>
      <input type="hidden" name="crop_x" id="crop_x">
      <input type="hidden" name="crop_y" id="crop_y">
      <input type="hidden" name="crop_size" id="crop_size" value="300">
      <input type="hidden" name="crop_scale" id="crop_scale" value="1">
      <p style="color:#6b7280; font-size:12px; margin-top:6px;">원형 영역 안에 사진을 드래그하여 위치를 조정하세요.</p>
    </div>

    <button type="submit" class="btn-primary">회원가입</button>

    <div style="text-align:center;margin-top:20px;">
      <a href="{% url 'uauth:login' %}" style="color:#718096;text-decoration:none;font-size:14px;">이미 계정이 있으신가요? 로그인</a>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const genderButtons = document.querySelectorAll(".gender-btn");
  const genderInput = document.getElementById("gender-input");
  const usernameInput = document.getElementById("username-input");
  const usernameFeedback = document.getElementById("username-feedback");
  const emailInput = document.getElementById("email-input");
  const emailFeedback = document.getElementById("email-feedback");
  const password1Input = document.getElementById("password1");
  const password2Input = document.getElementById("password2");
  const togglePassword1 = document.getElementById("toggle-password1");
  const togglePassword2 = document.getElementById("toggle-password2");
  const fileInput = document.getElementById("profile-image");
  const editor = document.getElementById("avatar-editor");
  const img = document.getElementById("avatar-image");
  const zoom = document.getElementById("avatar-zoom");
  const controls = document.getElementById("avatar-controls");
  const form = document.getElementById("register-form");
  const cropX = document.getElementById("crop_x");
  const cropY = document.getElementById("crop_y");
  const cropSize = document.getElementById("crop_size");
  const cropScale = document.getElementById("crop_scale");

  let debounceTimer;
  let imgLeft = 0, imgTop = 0;
  let naturalW = 0, naturalH = 0;

  // SVG 아이콘 상수
  const ICONS = {
    EYE: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
    EYE_OFF: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
  };

  // 성별 선택 기능
  genderButtons.forEach((btn) => {
    btn.addEventListener("click", function () {
      genderButtons.forEach((b) => b.classList.remove("selected"));
      this.classList.add("selected");
      genderInput.value = this.dataset.gender;
    });
  });
  // 초기 선택 반영 (서버에서 selected가 렌더된 경우)
  const initiallySelected = document.querySelector('.gender-btn.selected');
  if (initiallySelected) {
    genderInput.value = initiallySelected.dataset.gender;
  }

  // 아이디 중복 확인
  async function checkUsername(username) {
    if (username.length < 3) {
      usernameFeedback.innerHTML = '<span style="color: #6b7280;">아이디는 3자 이상 입력하세요.</span>';
      return;
    }

    usernameFeedback.innerHTML = '<span style="color: #6b7280;">확인 중...</span>';

    try {
      const response = await fetch('/uauth/check-username/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({username: username})
      });

      const data = await response.json();
      
      if (data.available) {
        usernameFeedback.innerHTML = '<span style="color: #10b981;">✓ 사용 가능한 아이디입니다.</span>';
      } else {
        usernameFeedback.innerHTML = '<span style="color: #ef4444;">✗ 이미 사용 중인 아이디입니다.</span>';
      }
    } catch (error) {
      usernameFeedback.innerHTML = '<span style="color: #ef4444;">확인 중 오류가 발생했습니다.</span>';
    }
  }

  // 비밀번호 가시성 토글
  function togglePasswordVisibility(input, toggleBtn) {
    if (input.type === "password") {
      input.type = "text";
      toggleBtn.innerHTML = ICONS.EYE_OFF;
    } else {
      input.type = "password";
      toggleBtn.innerHTML = ICONS.EYE;
    }
  }

  // 모든 비밀번호 토글 버튼 초기화
  function initPasswordToggles() {
    [togglePassword1, togglePassword2].forEach(btn => {
      btn.innerHTML = ICONS.EYE;
      btn.addEventListener('click', function() {
        const input = this.id === 'toggle-password1' ? password1Input : password2Input;
        togglePasswordVisibility(input, this);
      });
    });
  }

  initPasswordToggles();

  // 이메일 유효성 검사
  function validateEmail(email) {
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    return emailRegex.test(email);
  }

  // 이메일 입력 이벤트
  emailInput.addEventListener('input', function() {
    const email = this.value.trim();

    if (email === '') {
      emailFeedback.innerHTML = '';
      return;
    }

    if (validateEmail(email)) {
      emailFeedback.innerHTML = '<span style="color: #10b981;">✓ 올바른 이메일 형식입니다.</span>';
    } else {
      emailFeedback.innerHTML = '<span style="color: #ef4444;">✗ 올바른 이메일 형식을 입력해주세요. (예: user@example.com)</span>';
    }
  });

  // 아이디 입력 이벤트
  usernameInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const username = this.value.trim();

    if (username === '') {
      usernameFeedback.innerHTML = '';
      return;
    }

    debounceTimer = setTimeout(() => {
      checkUsername(username);
    }, 500);
  });

  function updateImage(){
    const s = parseFloat(zoom.value || '1');
    cropScale.value = String(s);
    img.style.transform = `scale(${s})`;
    img.style.left = imgLeft + 'px';
    img.style.top = imgTop + 'px';
  }

  // 프로필 이미지 미리보기 + 간단한 확대/이동
  fileInput?.addEventListener('change', () => {
    const file = fileInput.files?.[0];
    if (!file) { editor.style.display='none'; controls.style.display='none'; return; }
    if (!/image\/(jpeg|png|gif)/.test(file.type)) { alert('JPG/PNG/GIF만 가능합니다.'); fileInput.value=''; return; }
    if (file.size > 5 * 1024 * 1024) { alert('최대 5MB까지 가능합니다.'); fileInput.value=''; return; }

    const url = URL.createObjectURL(file);
    img.onload = () => {
      naturalW = img.naturalWidth; naturalH = img.naturalHeight;
      imgLeft = 0; imgTop = 0; zoom.value = '1'; cropScale.value = '1';
      editor.style.display='block'; controls.style.display='block';
      updateImage();
    };
    img.src = url;
  });

  zoom?.addEventListener('input', updateImage);

  let dragging = false; let startX = 0; let startY = 0;
  function startDrag(e){
    dragging = true;
    const p = e.touches?.[0] || e;
    startX = p.clientX - imgLeft;
    startY = p.clientY - imgTop;
    e.preventDefault();
  }
  function moveDrag(e){
    if (!dragging) return;
    const p = e.touches?.[0] || e;
    imgLeft = p.clientX - startX;
    imgTop = p.clientY - startY;
    updateImage();
  }
  function endDrag(){ dragging = false; }

  editor.addEventListener('mousedown', startDrag);
  editor.addEventListener('mousemove', moveDrag);
  document.addEventListener('mouseup', endDrag);
  editor.addEventListener('touchstart', startDrag, {passive:false});
  editor.addEventListener('touchmove', moveDrag, {passive:false});
  editor.addEventListener('touchend', endDrag);

  // 전송 전 crop 좌표 계산
  form.addEventListener('submit', () => {
    if (!img.src) return; // 이미지 선택 안한 경우 스킵
    const s = parseFloat(zoom.value || '1');
    const box = 300; // editor size
    const viewLeft = -imgLeft; // 스케일 적용 후 화면에서의 좌상단 여백
    const viewTop = -imgTop;
    const x = viewLeft / s;
    const y = viewTop / s;
    const size = box / s;
    cropX.value = Math.max(0, Math.round(x));
    cropY.value = Math.max(0, Math.round(y));
    cropSize.value = Math.round(size);
    cropScale.value = s.toFixed(2);
  });
});
</script>
{% endblock %}
