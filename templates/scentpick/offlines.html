{% extends "scentpick/base.html" %}
{% block title %}ì˜¤í”„ë¼ì¸ ë§¤ì¥ ì°¾ê¸° - ScentPick{% endblock %}

{% block content %}
<h2 style="margin-bottom:24px;color:#111827;">ì˜¤í”„ë¼ì¸ ë§¤ì¥ ì°¾ê¸°</h2>

<!-- í•´ì‹œíƒœê·¸(ì¶”ì²œ í‚¤ì›Œë“œ) ìŠ¤íƒ€ì¼ ê°œì„  -->
<style>
  .chip{
    padding:8px 12px;
    border:none;
    border-radius:999px;
    background:#f3f4f6;           /* ë°ì€ íšŒìƒ‰ */
    color:#1f2937;                 /* ì§„í•œ ê¸€ì */
    font-weight:600;
    font-size:13px;
    cursor:pointer;
    transition:all .15s ease;
  }
  .chip:hover{
    background:#e5e7eb;
    box-shadow:0 2px 8px rgba(0,0,0,.06);
    transform:translateY(-1px);
  }
</style>

<div style="display:grid;grid-template-columns:1.7fr 1fr;gap:16px;">
  <!-- ì§€ë„ -->
  <section id="mapSection" style="position:relative;border-radius:16px;overflow:hidden;background:#f1f5f9;min-height:560px;">
    <div id="map" style="height:560px;"></div>

    <!-- ë¹ ë¥¸íƒ­: ì§€ë„ ìœ„ ì˜¤ë²„ë ˆì´ -->
    <div id="presetBar" style="position:absolute;left:12px;top:12px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:6px 8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;z-index:1000;box-shadow:0 6px 16px rgba(0,0,0,.05);">
      <button class="preset" data-q="__ALL__" style="padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#eef2ff;">ì „ì²´</button>
      <button class="preset" data-q="ì˜¬ë¦¬ë¸Œì˜" style="padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;">ì˜¬ë¦¬ë¸Œì˜</button>
      <button class="preset" data-q="í–¥ìˆ˜ê³µë°©" style="padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;">í–¥ìˆ˜ê³µë°©</button>
      <button class="preset" data-q="ì¡°ë§ë¡ |ë”¥ë””í¬|ìƒ¤ë„¬|ë””ì˜¬|ë°”ì´ë ˆë„|ì´ì†|íƒ¬ë²„ë¦°ì¦ˆ|í†°í¬ë“œ|í”„ë¼ë‹¤" style="padding:6px 10px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;">ë¸Œëœë“œ ë§¤ì¥</button>
    </div>

    <!-- ë²”ë¡€ (ì¡°ê¸ˆ í‚¤ìš´ ë²„ì „) -->
    <div id="legend"
        style="position:absolute;right:12px;bottom:12px;background:#fff;border:1px solid #e5e7eb;
                border-radius:12px;padding:8px 12px;display:flex;gap:14px;align-items:center;
                z-index:999;box-shadow:0 6px 16px rgba(0,0,0,.05);">
      <span style="display:flex;gap:8px;align-items:center;">
        <i style="width:12px;height:12px;border-radius:999px;background:#2563eb;display:inline-block;"></i>
        <em style="font-style:normal;font-size:13px;color:#475569;">ë¸Œëœë“œ</em>
      </span>
      <span style="display:flex;gap:8px;align-items:center;">
        <i style="width:12px;height:12px;border-radius:999px;background:#10b981;display:inline-block;"></i>
        <em style="font-style:normal;font-size:13px;color:#475569;">ì˜¬ë¦¬ë¸Œì˜</em>
      </span>
      <span style="display:flex;gap:8px;align-items:center;">
        <i style="width:12px;height:12px;border-radius:999px;background:#f59e0b;display:inline-block;"></i>
        <em style="font-style:normal;font-size:13px;color:#475569;">í–¥ìˆ˜ê³µë°©</em>
      </span>
    </div>

  </section>

  <!-- ì‚¬ì´ë“œë°” -->
  <aside id="side" style="background:#fff;border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);">
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
      <span id="count" style="color:#64748b;font-size:12px;">0ê±´</span>
    </div>

    <!-- ê²€ìƒ‰ -->
    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <input id="q" placeholder="ì˜ˆ: ì˜¬ë¦¬ë¸Œì˜ ê°•ë‚¨, ë”¥ë””í¬, ìƒ¤ë„¬"
             style="flex:1;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#f8fafc;outline:none;">
      <button id="btnSearch" style="padding:10px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;">ê²€ìƒ‰</button>
    </div>

    <!-- ì»¨íŠ¸ë¡¤ -->
    <div style="display:flex;gap:10px;align-items:center;color:#64748b;font-size:12px;margin-bottom:10px;flex-wrap:wrap;">
      <span>ë²”ìœ„: ì§€ë„ ì¤‘ì‹¬ <strong>10km</strong></span>
      <label style="display:flex;gap:6px;align-items:center;cursor:pointer;">
        <input type="checkbox" id="autoRefresh" checked> ìë™ ìƒˆë¡œê³ ì¹¨
      </label>
      <button id="btnRequery" style="margin-left:auto;padding:6px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#fafafa;cursor:pointer;">í˜„ ì§€ë„ì—ì„œ ë‹¤ì‹œ ê²€ìƒ‰</button>
    </div>

    <!-- ì¶”ì²œ í‚¤ì›Œë“œ (ìƒˆ ìŠ¤íƒ€ì¼ ì ìš©) -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
      <button class="chip" data-q="ì˜¬ë¦¬ë¸Œì˜"># ì˜¬ë¦¬ë¸Œì˜</button>
      <button class="chip" data-q="í–¥ìˆ˜ê³µë°©"># í–¥ìˆ˜ê³µë°©</button>
      <button class="chip" data-q="í–¥ìˆ˜ ë§¤ì¥"># í–¥ìˆ˜ ë§¤ì¥</button>
      <button class="chip" data-q="ì¡°ë§ë¡ "># ì¡°ë§ë¡ </button>
      <button class="chip" data-q="ë”¥ë””í¬"># ë”¥ë””í¬</button>
      <button class="chip" data-q="ìƒ¤ë„¬"># ìƒ¤ë„¬</button>
    </div>

    <!-- ìƒíƒœ -->
    <div id="status" style="font-size:12px;color:#64748b;margin-bottom:8px;">ê²€ìƒ‰ ëŒ€ê¸° ì¤‘â€¦</div>

    <!-- ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ -->
    <ul id="list" style="display:flex;flex-direction:column;gap:10px;margin:0;padding:0;list-style:none;max-height:420px;overflow:auto;border-top:1px solid #f1f5f9;padding-top:8px;"></ul>

    <!-- ë”ë³´ê¸° -->
    <div id="moreWrap" style="display:none;margin-top:8px;">
      <button id="btnMore" style="width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa;cursor:pointer;">ë”ë³´ê¸°</button>
    </div>
  </aside>
</div>

<!-- ê¸¸ì°¾ê¸° ëª¨ë‹¬ -->
<div id="dirModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:1200;">
  <div style="background:#fff;border-radius:16px;max-width:520px;width:92%;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #e5e7eb;">
      <strong>ê¸¸ì°¾ê¸°</strong>
      <button id="dirClose" style="border:none;background:transparent;font-size:22px;line-height:1;cursor:pointer;">Ã—</button>
    </div>
    <div style="padding:14px 16px;display:flex;flex-direction:column;gap:10px;">
      <label style="display:flex;gap:8px;align-items:center;">
        <span style="min-width:58px;color:#374151;">ì¶œë°œì§€</span>
        <input id="dirStart" placeholder="ë¹„ì›Œë‘ë©´ ë‚´ ìœ„ì¹˜ ì‚¬ìš©"
               style="flex:1;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#f8fafc;outline:none;">
      </label>
      <div style="display:flex;gap:12px;align-items:center;">
        <span style="min-width:58px;color:#374151;">ì´ë™ìˆ˜ë‹¨</span>
        <label><input type="radio" name="dirMode" value="PUBLICTRANSIT" checked> ëŒ€ì¤‘êµí†µ</label>
        <label><input type="radio" name="dirMode" value="CAR"> ìë™ì°¨</label>
        <label><input type="radio" name="dirMode" value="FOOT"> ë„ë³´</label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px;">
        <button id="openKakaoDir" style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer;">ì¹´ì¹´ì˜¤ë§µìœ¼ë¡œ ì—´ê¸°</button>
        <button id="openGoogleDir" style="padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer;">êµ¬ê¸€ì§€ë„ë¡œ ì—´ê¸°</button>
      </div>
      <div id="dirHint" style="font-size:12px;color:#6b7280;">ìœ„ì¹˜ê¶Œí•œì„ í—ˆìš©í•˜ë©´ ì¶œë°œì§€ë¥¼ ìë™ìœ¼ë¡œ ì±„ì›Œì¤„ ìˆ˜ ìˆì–´ìš”.</div>
    </div>
  </div>
</div>
{% endblock content %}

{% block script %}
<script>
  const KAKAO_JS_KEY = "{{ KAKAO_JS_KEY|escapejs }}";

  /* ===== ì„¤ì •/ìƒíƒœ ===== */
  const SEARCH_RADIUS_M = 10000; // 10km
  let map, places, geocoder, clusterer;
  let markers = [];
  let markersById = new Map();

  let detailOverlay = null;
  let hoverOverlay  = null;

  let autoRefreshOn = true;
  let suppressAutoOnce = false;
  let lastViewportKey = '';
  let idleTimer = null;

  let currentQuery = '';
  let currentResults = [];
  let currentPagination = null;
  let isAppending = false;
  let lastSearch = null;

  // ê¸¸ì°¾ê¸° ëŒ€ìƒ
  let dirTarget = null;

  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const setCount  = n => $('#count').textContent = n + 'ê±´';
  const setStatus = m => $('#status').textContent = m;

  function viewportKey(){
    const c = map.getCenter();
    return c.getLat().toFixed(5) + ',' + c.getLng().toFixed(5) + '|' + map.getLevel();
  }

  /* === ì§€ë„ ë†’ì´ë¥¼ ì‚¬ì´ë“œë°”ì™€ ë™ì¼í•˜ê²Œ ë§ì¶”ê¸° === */
  function syncMapHeight(){
    const asideH = $('#side').offsetHeight;
    const h = Math.max(560, asideH);
    const mapEl = $('#map');
    if (mapEl.style.height !== h + 'px') {
      mapEl.style.height = h + 'px';
      if (window.kakao && map) setTimeout(() => map.relayout(), 0);
    }
  }

  /* ===== ë¶„ë¥˜/ìƒ‰ìƒ ===== */
  function catOf(name, categoryName='') {
    if (/ì˜¬ë¦¬ë¸Œì˜/i.test(name)) return 'OLIVE';
    if (/(ì¡°ë§ë¡ |ë”¥ë””í¬|ìƒ¤ë„¬|ë””ì˜¬|ëŒë¡œì—|êµ¬ì°Œ|ì…ìƒ|ì´ì†|ë°”ì´ë ˆë„|íƒ¬ë²„ë¦°ì¦ˆ|ì—ë¥´ë©”ìŠ¤|ìƒ¹í…Œì¹´ì´|í†°í¬ë“œ|í”„ë¼ë„|í”„ë¼ë‹¤)/i.test(name+categoryName)) return 'BRAND';
    return 'WORK'; // ë‚˜ë¨¸ì§€ëŠ” í–¥ìˆ˜ê³µë°© ì·¨ê¸‰
  }
  const CAT_COLOR = { BRAND:'#2563eb', OLIVE:'#10b981', WORK:'#f59e0b' };
  const CAT_TEXT  = { BRAND:'ë¸Œëœë“œ',   OLIVE:'ì˜¬ë¦¬ë¸Œì˜', WORK:'í–¥ìˆ˜ê³µë°©' };

  function markerImage(color) {
    const svg = "<svg xmlns='http://www.w3.org/2000/svg' width='28' height='28'>"
              + "<circle cx='14' cy='14' r='10' fill='"+color+"'/><circle cx='14' cy='14' r='4' fill='#fff'/></svg>";
    return new kakao.maps.MarkerImage(
      'data:image/svg+xml;base64,' + btoa(svg),
      new kakao.maps.Size(28, 28),
      { offset: new kakao.maps.Point(14, 14) }
    );
  }

  /* ====== (ì¤‘ìš”) ë·°í‹°/í–¥ìˆ˜ í•„í„°ë§ ê·œì¹™ + ë¸Œëœë“œ ì¿¼ë¦¬ í™•ì¥ ====== */
  const BRAND_TOKENS = ['ìƒ¤ë„¬','ë”¥ë””í¬','ì¡°ë§ë¡ ','ë””ì˜¬','ë°”ì´ë ˆë„','ì´ì†','íƒ¬ë²„ë¦°ì¦ˆ','í”„ë¼ë‹¤','í†°í¬ë“œ','ê²ì¡°','êµ¬ì°Œ','ëŒë¡œì—'];
  const BEAUTY_HINT_RE = /(í–¥ìˆ˜|í™”ì¥í’ˆ|ë·°í‹°|ë“œëŸ¬ê·¸|ë§¤ì¥|ìŠ¤í† ì–´|ë¶€í‹°í¬|í”Œë˜ê·¸ì‹­|ë°±í™”ì |ë©´ì„¸|ì˜¬ë¦¬ë¸Œì˜)/i;
  const EXCLUDE_RE = /(ë¯¸ìš©ì‹¤|í—¤ì–´|ë„¤ì¼|ì™ì‹±|ë§ˆì‚¬ì§€|ìŠ¤íŒŒ|í”¼ë¶€ê´€ë¦¬|ì—ìŠ¤í…Œí‹±|í”¼ë¶€ê³¼|ì¹˜ê³¼|ì•ˆê³¼|ì˜ì›|ë³‘ì›|ì•½êµ­|ì¹´í˜|ì‹ë‹¹|ìŒì‹ì |ìˆ™ë°•|í•™ì›|ë¶€ë™ì‚°|ì„¸íƒ|ìˆ˜ì„ |ìë™ì°¨|ì£¼ìœ ì†Œ|ì£¼ì°¨ì¥|ê³µì—…ì‚¬|PCë°©|ë…¸ë˜ë°©|ë‹¹êµ¬|ê³¨í”„|ì¸í…Œë¦¬ì–´)/i;

  function isBeautyPlace(d, q='') {
    const name = d.place_name || '';
    const cat  = d.category_name || '';
    const hay  = `${name} ${cat}`;

    if (EXCLUDE_RE.test(hay)) return false; // 1) ëª…ë°±í•œ ì œì™¸

    const qHasBrand = BRAND_TOKENS.some(b => q.includes(b));
    const qHasBeautyWord = /(í–¥ìˆ˜|í™”ì¥í’ˆ|ë·°í‹°)/i.test(q);

    // 2) ë¸Œëœë“œ/ë·°í‹° ê¸°ë°˜ ê²€ìƒ‰ì´ë©´ 'ë·°í‹° íŒíŠ¸'ê°€ ìˆëŠ” ê²ƒë§Œ
    if (qHasBrand || qHasBeautyWord) return BEAUTY_HINT_RE.test(hay);

    // 3) ê·¸ ì™¸(ë¹ ë¥¸ê²€ìƒ‰ ë“±)ëŠ” íŒíŠ¸ê°€ ìˆëŠ” ì¥ì†Œë§Œ
    return BEAUTY_HINT_RE.test(hay);
  }

  function maybeExpandBrandQuery(q) {
    const hit = BRAND_TOKENS.find(b => q.includes(b));
    const hasBeautyWord = /(í–¥ìˆ˜|í™”ì¥í’ˆ|ë·°í‹°|ë§¤ì¥|ìŠ¤í† ì–´|ë¶€í‹°í¬|ë°±í™”ì |ë©´ì„¸)/i.test(q);
    if (hit && !hasBeautyWord) {
      return [`${hit} í–¥ìˆ˜`, `${hit} ë·°í‹°`, `${hit} í™”ì¥í’ˆ`, `${hit} ë§¤ì¥`];
    }
    return null;
  }

  function toStore(d){
    const cat = catOf(`${d.place_name} ${d.category_name||''}`);
    return {
      id: d.id,
      name: d.place_name,
      addr: d.road_address_name || d.address_name || '',
      phone: d.phone || '',
      lat: parseFloat(d.y),
      lng: parseFloat(d.x),
      place_url: d.place_url || '#',
      cat
    };
  }

  /* ===== ì˜¤ë²„ë ˆì´ ===== */
  function closeDetail(){ if (detailOverlay) { detailOverlay.setMap(null); detailOverlay = null; } }
  function closeHover(){ if (hoverOverlay) { hoverOverlay.setMap(null); hoverOverlay = null; } }

  function openDetail(r, marker){
    closeDetail(); closeHover();
    const el = document.createElement('div');
    el.style.cssText = "background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.12);padding:10px 12px;min-width:220px;max-width:260px;";
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
        <div style="font-weight:700">${r.name}</div>
        <button type="button" class="sp-close" style="border:none;background:transparent;font-size:18px;line-height:1;cursor:pointer;">Ã—</button>
      </div>
      ${r.addr ? `<div style="color:#6b7280;margin-top:4px;">${r.addr}</div>` : ""}
      ${r.phone ? `<div style="color:#6b7280;margin-top:2px;">${r.phone}</div>` : ""}
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center;">
        <span style="display:inline-flex;gap:6px;align-items:center;font-size:12px;color:#334155">
          <i style="width:8px;height:8px;border-radius:999px;background:${CAT_COLOR[r.cat]}"></i>${CAT_TEXT[r.cat]}
        </span>
        <a href="${r.place_url}" target="_blank" rel="noreferrer" style="margin-left:auto;color:#2563eb;text-decoration:underline;white-space:nowrap;">ì¹´ì¹´ì˜¤ í˜ì´ì§€ ì—´ê¸°</a>
      </div>
    `;
    el.querySelector('.sp-close').onclick = closeDetail;

    detailOverlay = new kakao.maps.CustomOverlay({
      position: marker.getPosition(),
      content: el,
      xAnchor: 0.5,
      yAnchor: 1.2,
      zIndex: 7,
      clickable: true
    });
    detailOverlay.setMap(map);
  }

  function showHover(r, marker){
    closeHover();
    const el = document.createElement('div');
    el.style.cssText = "background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.1);padding:6px 8px;font-size:12px;max-width:240px;";
    el.innerHTML = `
      <div style="font-weight:600;margin-bottom:2px;">${r.name}</div>
      ${r.addr ? `<div style="color:#6b7280">${r.addr}</div>` : ""}
      ${r.phone ? `<div style="color:#6b7280;margin-top:2px;">${r.phone}</div>` : ""}
    `;
    hoverOverlay = new kakao.maps.CustomOverlay({
      position: marker.getPosition(),
      content: el,
      xAnchor: 0.5,
      yAnchor: 1.2,
      zIndex: 6,
      clickable: false
    });
    hoverOverlay.setMap(map);
  }

  /* ===== ë Œë”ë§ ===== */
  function clearMarkers(){
    markers.forEach(m => m.setMap(null));
    markers = [];
    markersById.clear();
    clusterer.clear();
  }

  function renderRows(rows, append=false){
    const ul = $('#list');
    if (!append) ul.innerHTML = '';
    const frag = document.createDocumentFragment();

    rows.forEach(r => {
      const li = document.createElement('li');
      li.style.cssText = 'border:1px solid #e5e7eb;border-radius:12px;padding:12px;display:flex;gap:10px;align-items:center;cursor:pointer;';
      li.innerHTML = `
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.name}</div>
          <div style="color:#64748b;font-size:12px;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.addr || ''}</div>
          ${r.phone ? `<div style="color:#64748b;font-size:12px;margin-top:2px;">${r.phone}</div>` : ''}
          <div style="margin-top:6px;display:flex;gap:6px;align-items:center;">
            <i style="width:8px;height:8px;border-radius:999px;background:${CAT_COLOR[r.cat]};display:inline-block;"></i>
            <span style="font-size:12px;color:#334155">${CAT_TEXT[r.cat]}</span>
          </div>
        </div>
        <div style="display:flex;gap:6px;flex-shrink:0">
          <button class="btn-dir" style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer;">ê¸¸ì°¾ê¸°</button>
          <a class="btn-mini" href="${r.place_url}" target="_blank" rel="noreferrer"
             style="padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fafafa;display:inline-block;text-decoration:none;color:#111827;">í˜ì´ì§€</a>
        </div>
      `;
      // ë¦¬ìŠ¤íŠ¸ í´ë¦­ -> ì§€ë„ í¬ì»¤ìŠ¤
      li.addEventListener('click', (e) => {
        if (e.target.closest('a') || e.target.closest('.btn-dir')) return;
        const marker = markersById.get(r.id);
        if (!marker) return;
        suppressAutoOnce = true;
        map.panTo(new kakao.maps.LatLng(r.lat, r.lng));
        setTimeout(() => openDetail(r, marker), 350);
      });
      // ê¸¸ì°¾ê¸° ë²„íŠ¼
      li.querySelector('.btn-dir').addEventListener('click', (e) => {
        e.stopPropagation();
        dirTarget = r;
        openDirModal();
      });

      frag.appendChild(li);
    });
    ul.appendChild(frag);

    if (!append) clearMarkers();
    const ms = rows.map(r => {
      const m = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(r.lat, r.lng),
        image: markerImage(CAT_COLOR[r.cat]),
        title: r.name
      });
      kakao.maps.event.addListener(m, 'mouseover', () => showHover(r, m));
      kakao.maps.event.addListener(m, 'mouseout',  closeHover);
      kakao.maps.event.addListener(m, 'click',     () => openDetail(r, m));
      m.__sid = r.id;
      markersById.set(r.id, m);
      return m;
    });
    markers.push(...ms);
    clusterer.addMarkers(ms);

    setCount($('#list').children.length);
    syncMapHeight();
  }

  /* ===== ê²€ìƒ‰ ===== */
  function handleSearch(data, status, pagination){
    if (status === kakao.maps.services.Status.OK) {
      // ğŸ” ê²°ê³¼ í•„í„°ë§ í›„ ë Œë”
      const filtered = data.filter(d => isBeautyPlace(d, currentQuery));
      const rows = filtered.map(toStore);

      if (isAppending) {
        currentResults.push(...rows);
        renderRows(rows, true);
      } else {
        currentResults = rows.slice();
        renderRows(rows, false);
      }
      currentPagination = pagination;
      setStatus(`"${currentQuery}" ê²°ê³¼: ${currentResults.length}ê±´`);
      $('#moreWrap').style.display = (pagination.current < pagination.last) ? 'block' : 'none';
      isAppending = false;
    } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
      if (!isAppending) {
        $('#list').innerHTML = '';
        clearMarkers(); setCount(0);
        setStatus(`"${currentQuery}" ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ`);
        $('#moreWrap').style.display = 'none';
        syncMapHeight();
      }
      isAppending = false;
    } else {
      setStatus('ê²€ìƒ‰ ì‹¤íŒ¨: ê¶Œí•œ/í‚¤/ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
      $('#moreWrap').style.display = 'none';
      isAppending = false;
      syncMapHeight();
    }
  }

  function searchOptions(){
    const c = map.getCenter();
    return { x:c.getLng(), y:c.getLat(), radius:SEARCH_RADIUS_M, size:15 };
  }

  function startSearch(query){
    // âœ¨ ë¸Œëœë“œ ë‹¨ì–´ë§Œ ìˆì„ ë•ŒëŠ” ìë™ ë‹¤ì¤‘ ê²€ìƒ‰ìœ¼ë¡œ í™•ì¥
    const expanded = maybeExpandBrandQuery(query);
    if (expanded) return multiSearch(expanded);

    lastSearch = { type:'single', query };
    currentQuery = query;
    currentPagination = null;
    isAppending = false;
    closeDetail(); closeHover();
    setStatus('ê²€ìƒ‰ ì¤‘â€¦');
    $('#moreWrap').style.display = 'none';
    places.keywordSearch(query, handleSearch, searchOptions());
  }

  function multiSearch(keywords){
    lastSearch = { type:'multi', keywords: keywords.slice() };
    closeDetail(); closeHover();
    setStatus('ë¹ ë¥¸ ê²€ìƒ‰ ì¤‘â€¦');
    $('#moreWrap').style.display = 'none';

    const bag = new Map();
    let pending = keywords.length;
    if (!pending) { setStatus('ê²€ìƒ‰ í‚¤ì›Œë“œ ì—†ìŒ'); return; }

    keywords.forEach(q => {
      places.keywordSearch(q, (data, status) => {
        if (status === kakao.maps.services.Status.OK) {
          data.forEach(d => {
            if (isBeautyPlace(d, q) && !bag.has(d.id)) bag.set(d.id, toStore(d));
          });
        }
        if (--pending === 0) {
          currentQuery   = 'ë¹ ë¥¸ê²€ìƒ‰';
          currentResults = Array.from(bag.values());
          currentPagination = null;
          renderRows(currentResults, false);
          setStatus(`ê²°ê³¼: ${currentResults.length}ê±´`);
          $('#moreWrap').style.display = 'none';
        }
      }, searchOptions());
    });
  }

  function runLastSearch(){
    closeDetail(); closeHover();
    if (!lastSearch) { $('.preset[data-q="__ALL__"]').click(); return; }
    if (lastSearch.type === 'single') startSearch(lastSearch.query);
    else multiSearch(lastSearch.keywords);
  }

  function more(){
    if (!currentPagination) return;
    if (currentPagination.current >= currentPagination.last) return;
    isAppending = true;
    setStatus('ë” ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦');
    currentPagination.nextPage();
  }

  /* ===== ê¸¸ì°¾ê¸° ëª¨ë‹¬ & ë§í¬ ===== */
  function openDirModal(){ $('#dirModal').style.display = 'flex'; $('#dirStart').focus(); }
  function closeDirModal(){ $('#dirModal').style.display = 'none'; }
  $('#dirClose').addEventListener('click', closeDirModal);
  $('#dirModal').addEventListener('click', (e)=>{ if(e.target.id==='dirModal') closeDirModal(); });

  function getSelectedMode(){
    const v = (document.querySelector('input[name="dirMode"]:checked')||{}).value || 'PUBLICTRANSIT';
    return v; // PUBLICTRANSIT | CAR | FOOT
  }
  const googleMode = { PUBLICTRANSIT:'transit', CAR:'driving', FOOT:'walking' };

  function geolocate(){
    return new Promise((resolve, reject)=>{
      if (!navigator.geolocation) return reject(new Error('GEO_UNSUPPORTED'));
      const opt = { enableHighAccuracy:false, timeout:6000, maximumAge:300000 };
      navigator.geolocation.getCurrentPosition(
        pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude, name:'ë‚´ ìœ„ì¹˜' }),
        err => reject(err),
        opt
      );
    });
  }

  function geocodeByText(text){
    return new Promise((resolve, reject)=>{
      geocoder.addressSearch(text, (res, status)=>{
        if (status === kakao.maps.services.Status.OK && res[0]) {
          const r = res[0]; return resolve({ lat: parseFloat(r.y), lng: parseFloat(r.x), name:text });
        }
        places.keywordSearch(text, (data, s)=>{
          if (s === kakao.maps.services.Status.OK && data[0]) {
            const d = data[0]; return resolve({ lat: parseFloat(d.y), lng: parseFloat(d.x), name:text });
          }
          reject(new Error('GEOCODE_FAIL'));
        }, { size:1 });
      });
    });
  }

  async function resolveStart(){
    const txt = $('#dirStart').value.trim();
    if (!txt) {
      try { return await geolocate(); }
      catch(_) { throw new Error('NEED_START'); }
    }
    return await geocodeByText(txt);
  }

  function openKakaoDirections(start, dest, mode){
    const scheme = `kakaomap://route?ep=${dest.lat},${dest.lng}${start ? `&sp=${start.lat},${start.lng}`:''}&by=${mode}`;
    const fromPart = start ? `/from/${encodeURIComponent(start.name)},${start.lat},${start.lng}` : '';
    const url = `https://map.kakao.com/link${fromPart}/to/${encodeURIComponent(dest.name)},${dest.lat},${dest.lng}`;
    try { window.location.href = scheme; } catch(_) {}
    setTimeout(()=> window.open(url, '_blank'), 400);
  }

  function openGoogleDirections(start, dest, mode){
    const base = 'https://www.google.com/maps/dir/?api=1';
    const params = new URLSearchParams({
      destination: `${dest.lat},${dest.lng}`,
      travelmode: ( { PUBLICTRANSIT:'transit', CAR:'driving', FOOT:'walking' }[mode] || 'transit')
    });
    if (start) params.set('origin', `${start.lat},${start.lng}`);
    window.open(`${base}&${params.toString()}`, '_blank');
  }

  async function handleOpenDirections(provider){
    if (!dirTarget) return;
    const dest = { lat: dirTarget.lat, lng: dirTarget.lng, name: dirTarget.name };
    const mode = getSelectedMode();
    let start = null;

    try { start = await resolveStart(); }
    catch (e) {
      if (e.message === 'NEED_START') { alert('ì¶œë°œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.'); return; }
      start = null; // ì§€ì˜¤ì½”ë”© ì‹¤íŒ¨ ì‹œ ëª©ì ì§€ë§Œ ì—´ê¸°
    }

    if (provider === 'kakao') openKakaoDirections(start, dest, mode);
    else openGoogleDirections(start, dest, mode);

    closeDirModal();
  }

  $('#openKakaoDir').addEventListener('click', ()=>handleOpenDirections('kakao'));
  $('#openGoogleDir').addEventListener('click', ()=>handleOpenDirections('google'));

  /* ===== ì´ë²¤íŠ¸ ===== */
  function bindEvents(){
    $$('.preset').forEach(btn => {
      btn.addEventListener('click', () => {
        $$('.preset').forEach(b => b.style.background = '#fff');
        btn.style.background = '#eef2ff';
        const q = btn.dataset.q;
        if (q === '__ALL__') {
          multiSearch(['ì˜¬ë¦¬ë¸Œì˜','í–¥ìˆ˜ê³µë°©','í–¥ìˆ˜ ë§¤ì¥','ì¡°ë§ë¡ ','ë”¥ë””í¬','ìƒ¤ë„¬','ë””ì˜¬','íƒ¬ë²„ë¦°ì¦ˆ','ì´ì†','ë°”ì´ë ˆë„']);
        } else if (q.includes('|')) {
          multiSearch(q.split('|'));
        } else {
          startSearch(q);
        }
      });
    });

    $('#btnSearch').addEventListener('click', () => {
      const q = $('#q').value.trim();
      if (!q) { $('.preset[data-q="__ALL__"]').click(); return; }
      startSearch(q);
    });
    $('#q').addEventListener('keydown', (e) => { if (e.key === 'Enter') $('#btnSearch').click(); });

    $$('.chip').forEach(ch => ch.addEventListener('click', () => {
      const q = ch.dataset.q;
      $('#q').value = q;
      startSearch(q);
    }));

    $('#autoRefresh').addEventListener('change', (e) => { autoRefreshOn = e.target.checked; });

    $('#btnRequery').addEventListener('click', runLastSearch);
    $('#btnMore').addEventListener('click', more);

    kakao.maps.event.addListener(map, 'click', () => { closeDetail(); closeHover(); });
    window.addEventListener('resize', () => { syncMapHeight(); });
  }

  /* ===== Kakao SDK ë¡œë” & ì´ˆê¸°í™” ===== */
  (function loadKakaoSDK(){
    const sdkUrl =
      'https://dapi.kakao.com/v2/maps/sdk.js?appkey=' +
      encodeURIComponent(KAKAO_JS_KEY) +
      '&libraries=services,clusterer&autoload=false';
    const s = document.createElement('script');
    s.src = sdkUrl; s.async = true; s.defer = true;
    s.onload = () => {
      if (!(window.kakao && window.kakao.maps)) { $('#map').innerHTML = 'ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'; return; }
      kakao.maps.load(initMap);
    };
    s.onerror = () => { $('#map').innerHTML = 'ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (SDK ë¡œë“œ ì‹¤íŒ¨)'; };
    document.head.appendChild(s);
  })();

  function initMap(){
    const center = new kakao.maps.LatLng(37.498095, 127.027610); // ê°•ë‚¨ì—­
    map = new kakao.maps.Map(document.getElementById('map'), { center, level:5 });
    places = new kakao.maps.services.Places();
    geocoder = new kakao.maps.services.Geocoder();
    clusterer = new kakao.maps.MarkerClusterer({ map, averageCenter:true, minLevel:7 });

    bindEvents();

    kakao.maps.event.addListener(map, 'idle', () => {
      if (suppressAutoOnce) { suppressAutoOnce = false; lastViewportKey = viewportKey(); return; }
      const vk = viewportKey();
      if (vk === lastViewportKey) return;
      lastViewportKey = vk;
      if (!autoRefreshOn) return;
      clearTimeout(idleTimer);
      idleTimer = setTimeout(runLastSearch, 400);
    });

    lastViewportKey = viewportKey();
    $('.preset[data-q="__ALL__"]').click();
    syncMapHeight();
  }
</script>
{% endblock script %}
