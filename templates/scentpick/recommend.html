{% extends "scentpick/base.html" %}
{% block title %}맞춤 추천 - ScentPick{% endblock title %}
{% block content %}

{% if request.GET.lat and request.GET.lon %}
<div class="page-container" style="max-width:1400px;margin:0 auto;padding:20px;">
  <div class="page-header" style="text-align:center;margin-bottom:40px;">
    <h1 style="color:#1e3a8a;font-size:32px;font-weight:900;margin-bottom:8px;">맞춤 향수 추천</h1>
    <p style="color:#64748b;font-size:16px;margin:0;">사용자님의 성별과 오늘의 날씨를 반영해 가장 어울리는 향수를 추천드렸습니다.</p>
  </div>

  <!-- 추천 섹션 -->
  <div class="recommend-section" style="margin-bottom:60px;">
    <!-- 오늘의 날씨 기반 추천 -->
    <div class="recommendation-card" style="background:linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);border-radius:24px;padding:32px;margin-bottom:32px;box-shadow:0 20px 64px rgba(30,64,175,0.3);position:relative;overflow:hidden;">
      <div style="position:absolute;inset:0;background-image:url('data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot;><g fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;><g fill=&quot;%23ffffff&quot; fill-opacity=&quot;0.05&quot;><circle cx=&quot;7&quot; cy=&quot;7&quot; r=&quot;7&quot;/><circle cx=&quot;53&quot; cy=&quot;53&quot; r=&quot;7&quot;/></g></g></svg>');background-size:60px 60px;opacity:.15;"></div>

      <div style="position:relative;z-index:1;">
        <h2 style="color:white;margin-bottom:24px;font-size:26px;font-weight:800;text-align:center;">🌤️ 오늘의 날씨 추천</h2>

        <div class="weather-info" style="background:rgba(255,255,255,0.15);backdrop-filter:blur(20px);padding:24px;border-radius:16px;margin-bottom:28px;border:1px solid rgba(255,255,255,0.2);">
          <div style="display:flex;align-items:center;gap:20px;margin-bottom:16px;">
            <div style="font-size:48px;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.1));">{{ weather_emoji|default:"🌤️" }}</div>
            <div>
              <div style="font-size:24px;font-weight:800;color:white;margin-bottom:4px;">
                {{ weather_line1|default:"맑음, -°C" }}
              </div>
              <div style="color:rgba(255,255,255,0.8);font-size:16px;">
                {{ weather_line2|default:"습도 -%, 바람 -" }}
              </div>
            </div>
          </div>
          <p style="color:rgba(255,255,255,0.95);margin:0;font-size:16px;line-height:1.5;">
            {{ weather_tip|default:"오늘 기분에 맞는 향을 가볍게 시향해 보세요 :)" }}
          </p>
        </div>

        <!-- 날씨 기반 추천 리스트 -->
        <div class="products-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;">
          {% for p in perfumes %}
            {% if p.detail_url %}
              <a href="https://scentpick.store/perfume/{{ p.id }}" target="_blank" rel="noopener" class="product-card weather-card">
            {% else %}
              <div class="product-card weather-card">
            {% endif %}

                <div class="product-image" style="position:relative;width:100%;aspect-ratio:1/1;overflow:hidden;border-radius:16px;background:#f8fafc;box-shadow:0 8px 24px rgba(0,0,0,0.15);">
                  {% if p.image_url %}
                    <img src="{{ p.image_url }}"
                         alt="{{ p.brand }} {{ p.name }}"
                         loading="lazy" decoding="async" referrerpolicy="no-referrer"
                         onerror="this.onerror=null;this.src='/static/img/placeholder.png';"
                         style="width:100%;height:100%;object-fit:cover;display:block;transition:transform 0.4s ease;">
                  {% else %}
                    <img src="/static/img/placeholder.png"
                         alt="no image"
                         loading="lazy" decoding="async"
                         style="width:100%;height:100%;object-fit:cover;display:block;">
                  {% endif %}
                </div>

                <div class="product-info" style="margin-top:16px;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:16px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
                  <div class="product-brand" style="font-weight:800;color:#1e3a8a;font-size:15px;margin-bottom:4px;">
                    {{ p.brand }}
                  </div>
                  <div class="product-name" style="color:#475569;font-size:14px;margin-bottom:8px;line-height:1.3;">
                    {{ p.name }}
                  </div>
                  {% if p.price %}
                    <div class="product-price" style="color:#0f766e;font-weight:700;font-size:16px;">₩{{ p.price }}</div>
                  {% endif %}
                </div>

            {% if p.detail_url %}
              </a>
            {% else %}
              </div>
            {% endif %}
          {% empty %}
            <div style="color:rgba(255,255,255,0.8);text-align:center;grid-column:1/-1;padding:40px;background:rgba(255,255,255,0.1);border-radius:16px;">
              <div style="font-size:48px;margin-bottom:16px;">🔍</div>
              조건에 맞는 추천 향수가 아직 없습니다.
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- 계절 맞춤 추천 -->
    <div class="recommendation-card" style="background:linear-gradient(135deg, #1e40af 0%, #2563eb 50%, #3b82f6 100%);border-radius:24px;padding:32px;box-shadow:0 20px 64px rgba(30,64,175,0.25);position:relative;overflow:hidden;">
      <div style="position:absolute;inset:0;background-image:url('data:image/svg+xml;utf8,<svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;40&quot; height=&quot;40&quot; viewBox=&quot;0 0 40 40&quot;><g fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;><g fill=&quot;%23ffffff&quot; fill-opacity=&quot;0.08&quot;><rect width=&quot;2&quot; height=&quot;40&quot; x=&quot;19&quot;/><rect width=&quot;40&quot; height=&quot;2&quot; y=&quot;19&quot;/></g></g></svg>');background-size:40px 40px;opacity:.12;"></div>

      <div style="position:relative;z-index:1;">
        <h2 style="color:white;margin-bottom:24px;font-size:26px;font-weight:800;text-align:center;">🍂 {{ season_title|default:"지금 계절 추천 Top 3" }}</h2>
        
        <div class="season-info" style="background:rgba(255,255,255,0.15);backdrop-filter:blur(20px);padding:20px;border-radius:16px;margin-bottom:28px;border:1px solid rgba(255,255,255,0.2);">
          <p style="color:rgba(255,255,255,0.95);margin:0;font-size:16px;text-align:center;line-height:1.5;">{{ season_tip|default:"요즘 계절에 어울리는 향을 골랐어요." }}</p>
        </div>

        <div class="products-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;">
          {% for p in seasonal_perfumes %}
            {% if p.detail_url %}
              <a href="https://scentpick.store/perfume/{{ p.id }}" target="_blank" rel="noopener" class="product-card season-card">
            {% else %}
              <div class="product-card season-card">
            {% endif %}

                <div class="product-image" style="position:relative;width:100%;aspect-ratio:1/1;overflow:hidden;border-radius:16px;background:#f8fafc;box-shadow:0 8px 24px rgba(0,0,0,0.15);">
                  {% if p.image_url %}
                    <img src="{{ p.image_url }}"
                         alt="{{ p.brand }} {{ p.name }}"
                         loading="lazy" decoding="async" referrerpolicy="no-referrer"
                         onerror="this.onerror=null;this.src='/static/img/placeholder.png';"
                         style="width:100%;height:100%;object-fit:cover;display:block;transition:transform 0.4s ease;">
                  {% else %}
                    <img src="/static/img/placeholder.png"
                         alt="no image"
                         loading="lazy" decoding="async"
                         style="width:100%;height:100%;object-fit:cover;display:block;">
                  {% endif %}
                </div>

                <div class="product-info" style="margin-top:16px;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);padding:16px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.1);">
                  <div class="product-brand" style="font-weight:800;color:#1e3a8a;font-size:15px;margin-bottom:4px;">
                    {{ p.brand }}
                  </div>
                  <div class="product-name" style="color:#475569;font-size:14px;margin-bottom:8px;line-height:1.3;">
                    {{ p.name }}
                  </div>
                  {% if p.price %}
                    <div class="product-price" style="color:#0f766e;font-weight:700;font-size:16px;">₩{{ p.price }}</div>
                  {% endif %}
                </div>

            {% if p.detail_url %}
              </a>
            {% else %}
              </div>
            {% endif %}
          {% empty %}
            <div style="color:rgba(255,255,255,0.8);text-align:center;grid-column:1/-1;padding:40px;background:rgba(255,255,255,0.1);border-radius:16px;">
              <div style="font-size:48px;margin-bottom:16px;">🌸</div>
              지금 계절에 맞는 추천이 아직 없어요.
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- 향수 월드컵 섹션 -->
  <div class="worldcup-section" style="background:linear-gradient(135deg, #eff6ff 0%, #dbeafe 50%, #bfdbfe 100%);border-radius:28px;padding:40px;box-shadow:0 24px 80px rgba(59,130,246,0.15);position:relative;overflow:hidden;content-visibility:auto;contain-intrinsic-size:1200px;">
    <div style="position:absolute;top:-50px;right:-50px;width:200px;height:200px;background:linear-gradient(45deg, #3b82f6, #60a5fa);border-radius:50%;opacity:0.1;"></div>
    <div style="position:absolute;bottom:-30px;left:-30px;width:150px;height:150px;background:linear-gradient(45deg, #1e40af, #3b82f6);border-radius:50%;opacity:0.08;"></div>
    
    <div style="position:relative;z-index:1;">
      <div class="worldcup-header" style="text-align:center;margin-bottom:40px;">
        <h2 style="color:#1e3a8a;font-size:32px;font-weight:900;margin-bottom:12px;">🎮 향수 월드컵</h2>
        <p style="color:#64748b;font-size:18px;margin:0;">나만의 취향을 찾아가는 재미있는 여정</p>
      </div>
      
      <div style="display:grid;grid-template-columns:400px 1fr;gap:40px;">
        <!-- 왼쪽: 단계별 질문지 -->
        <div class="quiz-panel" style="background:rgba(255,255,255,0.9);backdrop-filter:blur(20px);border:2px solid rgba(59,130,246,0.2);border-radius:20px;padding:32px;height:fit-content;box-shadow:0 12px 40px rgba(59,130,246,0.1);">
          <div class="quiz-header" style="text-align:center;margin-bottom:28px;">
            <div style="width:80px;height:80px;background:linear-gradient(135deg, #3b82f6, #1e40af);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;box-shadow:0 8px 24px rgba(59,130,246,0.3);">
              <span style="font-size:36px;">🎯</span>
            </div>
            <h3 style="color:#1e3a8a;font-size:20px;font-weight:800;margin:0;">취향 찾기</h3>
          </div>
          
          <form method="get" action="{% url 'scentpick:recommend' %}" id="quiz-form">
            <!-- 질문 1: 성별 -->
            <div class="quiz-step active" id="step-1" style="display:block;">
              <div class="question-header" style="text-align:center;margin-bottom:24px;">
                <div style="color:#3b82f6;font-size:18px;font-weight:700;margin-bottom:8px;">1/3</div>
                <h4 style="color:#1e3a8a;font-size:18px;font-weight:700;margin:0;">어떤 성별의 향수를 찾고 계신가요?</h4>
              </div>
              
              <div style="display:grid;gap:12px;">
                <label class="quiz-option" data-value="남성" style="display:flex;align-items:center;gap:16px;padding:16px 20px;border:2px solid #e5e7eb;border-radius:16px;cursor:pointer;background:white;transition:all 0.3s;">
                  <div style="width:50px;height:50px;background:linear-gradient(135deg, #60a5fa, #3b82f6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;">👨</div>
                  <div>
                    <div style="font-weight:700;color:#1e3a8a;font-size:16px;">남성</div>
                    <div style="color:#64748b;font-size:14px;">깔끔하고 시원한 향</div>
                  </div>
                </label>
                <label class="quiz-option" data-value="여성" style="display:flex;align-items:center;gap:16px;padding:16px 20px;border:2px solid #e5e7eb;border-radius:16px;cursor:pointer;background:white;transition:all 0.3s;">
                  <div style="width:50px;height:50px;background:linear-gradient(135deg, #f472b6, #ec4899);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;">👩</div>
                  <div>
                    <div style="font-weight:700;color:#1e3a8a;font-size:16px;">여성</div>
                    <div style="color:#64748b;font-size:14px;">우아하고 섬세한 향</div>
                  </div>
                </label>
                <label class="quiz-option" data-value="남녀공용" style="display:flex;align-items:center;gap:16px;padding:16px 20px;border:2px solid #e5e7eb;border-radius:16px;cursor:pointer;background:white;transition:all 0.3s;">
                  <div style="width:50px;height:50px;background:linear-gradient(135deg, #34d399, #10b981);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;">👫</div>
                  <div>
                    <div style="font-weight:700;color:#1e3a8a;font-size:16px;">남녀공용</div>
                    <div style="color:#64748b;font-size:14px;">누구나 좋아하는 향</div>
                  </div>
                </label>
              </div>
            </div>

            <!-- 질문 2: 어코드 -->
            <div class="quiz-step" id="step-2" style="display:none;">
              <div class="question-header" style="text-align:center;margin-bottom:24px;">
                <div style="color:#3b82f6;font-size:18px;font-weight:700;margin-bottom:8px;">2/3</div>
                <h4 style="color:#1e3a8a;font-size:18px;font-weight:700;margin:0;">어떤 향의 느낌을 선호하시나요?</h4>
              </div>
              
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                {% for opt in accord_options %}
                  <label class="quiz-option" data-value="{{ opt }}" style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:16px;border:2px solid #e5e7eb;border-radius:16px;cursor:pointer;background:white;transition:all 0.3s;text-align:center;">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg, #a78bfa, #8b5cf6);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;">🌸</div>
                    <div style="font-weight:600;color:#1e3a8a;font-size:14px;">{{ opt }}</div>
                  </label>
                {% endfor %}
              </div>
              
              <button type="button" class="prev-btn" style="margin-top:20px;padding:12px 24px;border:2px solid #e5e7eb;border-radius:12px;background:white;color:#64748b;font-weight:600;cursor:pointer;width:100%;">← 이전</button>
            </div>

            <!-- 질문 3: 시간대 -->
            <div class="quiz-step" id="step-3" style="display:none;">
              <div class="question-header" style="text-align:center;margin-bottom:24px;">
                <div style="color:#3b82f6;font-size:18px;font-weight:700;margin-bottom:8px;">3/3</div>
                <h4 style="color:#1e3a8a;font-size:18px;font-weight:700;margin:0;">언제 사용하실 예정인가요?</h4>
              </div>
              
              <div style="display:grid;gap:16px;">
                <label class="quiz-option" data-value="day" style="display:flex;align-items:center;gap:16px;padding:20px;border:2px solid #e5e7eb;border-radius:16px;cursor:pointer;background:white;transition:all 0.3s;">
                  <div style="width:60px;height:60px;background:linear-gradient(135deg, #fbbf24, #f59e0b);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;">🌅</div>
                  <div>
                    <div style="font-weight:700;color:#1e3a8a;font-size:16px;">낮 시간대</div>
                    <div style="color:#64748b;font-size:14px;">가볍고 상쾌한 일상용 향수</div>
                  </div>
                </label>
                <label class="quiz-option" data-value="night" style="display:flex;align-items:center;gap:16px;padding:20px;border:2px solid #e5e7eb;border-radius:16px;cursor:pointer;background:white;transition:all 0.3s;">
                  <div style="width:60px;height:60px;background:linear-gradient(135deg, #6366f1, #4f46e5);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;">🌙</div>
                  <div>
                    <div style="font-weight:700;color:#1e3a8a;font-size:16px;">밤 시간대</div>
                    <div style="color:#64748b;font-size:14px;">깊고 매혹적인 특별한 향수</div>
                  </div>
                </label>
              </div>
              
              <div style="display:flex;gap:12px;margin-top:20px;">
                <button type="button" class="prev-btn" style="flex:1;padding:12px 24px;border:2px solid #e5e7eb;border-radius:12px;background:white;color:#64748b;font-weight:600;cursor:pointer;">← 이전</button>
                <button type="submit" class="submit-btn" style="flex:2;padding:12px 24px;border:none;border-radius:12px;background:linear-gradient(135deg, #3b82f6, #1e40af);color:white;font-weight:700;cursor:pointer;box-shadow:0 4px 16px rgba(59,130,246,0.4);">✨ 결과 보기</button>
              </div>
            </div>

            <!-- 숨겨진 input들 -->
            <input type="hidden" name="g" id="gender-input">
            <input type="hidden" name="a" id="accord-input">
            <input type="hidden" name="t" id="time-input">
            <input type="hidden" name="lat" value="{{ request.GET.lat }}">
            <input type="hidden" name="lon" value="{{ request.GET.lon }}">

            {% if worldcup_candidates|length == 0 and wc_selected_gender and wc_selected_accord and wc_selected_time %}
              <div style="color:#ef4444;text-align:center;padding:16px;background:rgba(239,68,68,0.1);border-radius:12px;font-size:14px;margin-top:16px;">조건에 맞는 후보가 부족합니다. 다른 조합으로 시도해보세요.</div>
            {% endif %}
          </form>
        </div>

        <!-- 오른쪽: 월드컵 UI -->
        <div class="tournament-panel" style="background:rgba(255,255,255,0.9);backdrop-filter:blur(20px);border:2px solid rgba(59,130,246,0.2);border-radius:20px;padding:32px;box-shadow:0 12px 40px rgba(59,130,246,0.1);overflow-anchor:none;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;">
            <h3 style="margin:0;color:#1e3a8a;font-size:22px;font-weight:800;">🏆 토너먼트</h3>
            {% if worldcup_candidates|length >= 2 %}
              <button id="wc-start" type="button" style="padding:12px 20px;border:2px solid #3b82f6;border-radius:12px;background:linear-gradient(135deg, #3b82f6, #1e40af);color:white;cursor:pointer;font-weight:700;transition:all 0.3s;box-shadow:0 4px 16px rgba(59,130,246,0.3);">
                🚀 게임 시작
              </button>
            {% endif %}
          </div>

          {% if worldcup_candidates %}
            <div id="wc-candidate-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;">
              {% for c in worldcup_candidates|slice:":12" %}
                <div class="candidate-card" style="border:2px solid #e5e7eb;border-radius:16px;overflow:hidden;background:white;transition:all 0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.1);">
                  <div style="aspect-ratio:1/1;background:#f8fafc;overflow:hidden;">
                    <img src="{{ c.image_url }}"
                         alt="{{ c.brand }} {{ c.name }}"
                         loading="lazy" decoding="async" referrerpolicy="no-referrer"
                         onerror="this.onerror=null;this.src='/static/img/placeholder.png';"
                         style="width:100%;height:100%;object-fit:cover;display:block;transition:transform 0.3s;">
                  </div>
                  <div style="padding:12px;">
                    <div style="font-weight:700;color:#1e3a8a;font-size:13px;margin-bottom:4px;line-height:1.2;">{{ c.brand }}</div>
                    <div style="color:#64748b;font-size:12px;margin-bottom:8px;line-height:1.2;">{{ c.name }}</div>
                    <div style="color:#9ca3af;font-size:10px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;line-height:1.3;">
                      {{ c.description }}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>

            <!-- 매치 진행 영역 -->
            <div id="wc-stage" style="display:none;margin-top:24px;">
              <div id="wc-round-label" style="font-weight:800;color:#1e3a8a;margin-bottom:20px;text-align:center;font-size:20px;">Round 8</div>
              <div id="wc-match" style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
                <!-- 두 카드가 JS로 주입됨 -->
              </div>
            </div>

          {% else %}
            <div style="color:#64748b;text-align:center;padding:60px 20px;background:rgba(59,130,246,0.05);border-radius:16px;border:2px dashed #bfdbfe;">
              <div style="font-size:64px;margin-bottom:20px;">🎯</div>
              <div style="font-size:18px;font-weight:600;margin-bottom:8px;color:#1e3a8a;">월드컵 준비 완료!</div>
              <div style="font-size:14px;">왼쪽 질문에 답하고 나만의 향수를 찾아보세요</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% else %}
<!-- lat/lon 없을 때: 로딩 화면 -->
<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:60vh;">
  <div style="color:#475569;font-size:18px;">📍현재 위치의 날씨를 불러오고 있어요...</div>
</div>
{% endif %}

<style>
.product-card { text-decoration:none !important; color:inherit; transition:all .4s cubic-bezier(0.4,0,0.2,1); display:block; }
.weather-card:hover, .season-card:hover { transform:translateY(-8px) scale(1.02); }
.weather-card:hover .product-image img, .season-card:hover .product-image img { transform:scale(1.1); }
.quiz-option { transition:all .3s ease !important; }
.quiz-option:hover { border-color:#3b82f6 !important; background:#eff6ff !important; transform:translateY(-2px); box-shadow:0 8px 24px rgba(59,130,246,.2) !important; }
.quiz-option.selected { border-color:#1e40af !important; background:linear-gradient(135deg,#dbeafe,#bfdbfe) !important; box-shadow:0 8px 24px rgba(59,130,246,.3) !important; }
.submit-btn:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(59,130,246,.6) !important; }
.candidate-card:hover { transform:translateY(-4px); border-color:#3b82f6 !important; background:#eff6ff !important; box-shadow:0 12px 32px rgba(59,130,246,.2) !important; }
.candidate-card:hover img { transform:scale(1.05); }
#wc-start:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(59,130,246,.5) !important; }
.prev-btn:hover { border-color:#3b82f6 !important; background:#eff6ff !important; color:#1e40af !important; }
.quiz-step { animation:fadeIn .5s ease-in-out; }
@keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
.progress-bar { width:100%; height:6px; background:#e5e7eb; border-radius:3px; margin-bottom:24px; overflow:hidden; }
.progress-fill { height:100%; background:linear-gradient(90deg,#3b82f6,#1e40af); border-radius:3px; transition:width .5s ease; }
.product-image { min-height:220px; }
</style>

{% endblock content %}

{% block script %}
{% if not request.GET.lat or not request.GET.lon %}
  <script>
  // 초기 진입은 항상 맨 위에서 시작(앵커/자동 스크롤 없음)
  document.addEventListener("DOMContentLoaded", () => {
    if (navigator.geolocation) {
      const fallback = () => {
        const lat = 37.48642884662146, lon = 127.02087044474453;
        window.location.replace(`/recommend?lat=${lat}&lon=${lon}`);
      };
      const timer = setTimeout(fallback, 1500);
      navigator.geolocation.getCurrentPosition(
        (pos) => { clearTimeout(timer); window.location.replace(`/recommend?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`); },
        () => { clearTimeout(timer); fallback(); },
        { enableHighAccuracy:false, maximumAge:300000, timeout:1200 }
      );
    } else {
      window.location.replace(`/recommend`);
    }
  });
  </script>
{% endif %}

  <!-- 월드컵 후보 데이터: 클릭 시점에 파싱 -->
  <script id="wc-data" type="application/json">{{ worldcup_candidates_json|default:"[]"|safe }}</script>

  <script>
  // 폼 제출 시 스크롤 위치 보존 + 새로고침 후 복원
  (function(){
    try { if ('scrollRestoration' in history) { history.scrollRestoration = 'manual'; } } catch(_) {}
    const restore = () => {
      const flag = sessionStorage.getItem('restore-scroll');
      if (flag === '1') {
        const y = parseFloat(sessionStorage.getItem('restore-scroll-y') || '0');
        // 여러 번 시도해서 레이아웃 완성 후 복원
        const doScroll = () => window.scrollTo(0, y);
        requestAnimationFrame(() => { doScroll(); setTimeout(doScroll, 0); });
        window.addEventListener('load', doScroll, { once:true });
        sessionStorage.removeItem('restore-scroll');
        sessionStorage.removeItem('restore-scroll-y');
      }
    };
    document.addEventListener('DOMContentLoaded', restore);
  })();

  // 안전한 텍스트
  function escapeHTML(str){
    return (str ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&gt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // 단계별 퀴즈
  let currentStep = 1;
  let answers = { gender:'', accord:'', time:'' };

  function showStep(stepNum) {
    document.querySelectorAll('.quiz-step').forEach(step => { step.style.display = 'none'; });
    document.getElementById(`step-${stepNum}`).style.display = 'block';
    const progressFill = document.querySelector('.progress-fill');
    if (progressFill) progressFill.style.width = `${(stepNum/3)*100}%`;
  }
  function nextStep(){ if (currentStep < 3) { currentStep++; showStep(currentStep); } }
  function prevStep(){ if (currentStep > 1) { currentStep--; showStep(currentStep); } }

  document.addEventListener('DOMContentLoaded', function() {
    const quizHeader = document.querySelector('.quiz-header');
    if (quizHeader) {
      const progressBar = document.createElement('div');
      progressBar.className = 'progress-bar';
      progressBar.innerHTML = '<div class="progress-fill" style="width:33.33%;"></div>';
      quizHeader.insertAdjacentElement('afterend', progressBar);
    }
    currentStep = 1; showStep(1);

    document.querySelectorAll('#step-1 .quiz-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('#step-1 .quiz-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        answers.gender = this.dataset.value;
        document.getElementById('gender-input').value = answers.gender;
        setTimeout(nextStep, 500);
      });
    });

    document.querySelectorAll('#step-2 .quiz-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('#step-2 .quiz-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        answers.accord = this.dataset.value;
        document.getElementById('accord-input').value = answers.accord;
        setTimeout(nextStep, 500);
      });
    });

    document.querySelectorAll('#step-3 .quiz-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('#step-3 .quiz-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        answers.time = this.dataset.value;
        document.getElementById('time-input').value = answers.time;
      });
    });

    document.querySelectorAll('.prev-btn').forEach(btn => btn.addEventListener('click', prevStep));

    // 결과 보기: 스크롤 위치 저장 후 이동
    const form = document.getElementById('quiz-form');
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        try {
          sessionStorage.setItem('restore-scroll', '1');
          sessionStorage.setItem('restore-scroll-y', String(window.scrollY || window.pageYOffset || 0));
        } catch(_) {}
        const action = form.getAttribute('action') || window.location.pathname;
        const params = new URLSearchParams(new FormData(form));
        window.location.assign(`${action}?${params.toString()}`);
      });
    }
  });

  // 월드컵 토너먼트
  let CANDIDATES = null; // 클릭 시 파싱
  const startBtn = document.getElementById("wc-start");
  const stage = document.getElementById("wc-stage");
  const grid = document.getElementById("wc-candidate-grid");
  const matchBox = document.getElementById("wc-match");
  const roundLabel = document.getElementById("wc-round-label");
  const panel = document.querySelector('.tournament-panel');

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

  function cardHTML(item, idx){
    return `
      <div class="wc-card" data-idx="${idx}"
           style="cursor:pointer;border:3px solid #e5e7eb;border-radius:20px;overflow:hidden;background:white;transition:all .4s cubic-bezier(0.4,0,0.2,1);box-shadow:0 8px 32px rgba(0,0,0,.1);position:relative;">
        <div style="position:absolute;top:12px;left:12px;background:rgba(30,58,138,.9);color:white;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;backdrop-filter:blur(10px);">
          선택하세요
        </div>
        <div style="aspect-ratio:1/1;background:#f8fafc;overflow:hidden;">
          <img src="${item.image_url}"
               alt="${escapeHTML(item.brand)} ${escapeHTML(item.name)}"
               loading="lazy" decoding="async" referrerpolicy="no-referrer"
               onerror="this.onerror=null;this.src='/static/img/placeholder.png';"
               style="width:100%;height:100%;object-fit:cover;display:block;transition:transform .4s ease;">
        </div>
        <div style="padding:20px;">
          <div style="font-weight:800;color:#1e3a8a;font-size:18px;margin-bottom:6px;line-height:1.2;">${escapeHTML(item.brand)}</div>
          <div style="color:#64748b;font-size:16px;margin-bottom:12px;line-height:1.3;">${escapeHTML(item.name)}</div>
          <div style="color:#9ca3af;font-size:13px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;line-height:1.4;">
            ${escapeHTML(item.description || "")}
          </div>
        </div>
      </div>`;
  }

  function runTournament(items){
    const prevY = window.scrollY;
    stage.style.display = "block";
    if (grid) grid.style.display = "none";
    requestAnimationFrame(() => window.scrollTo({ top: prevY, behavior: 'auto' }));

    let current = shuffle(items.slice());
    let round = current.length;
    let pairIdx = 0;
    let winners = [];

    function updateRoundLabel(){ 
      let roundName = '';
      switch(round) { case 8: roundName='8강'; break; case 4: roundName='준결승'; break; case 2: roundName='결승'; break; default: roundName = `Round ${round}`; }
      roundLabel.innerHTML = `<span style="color:#3b82f6;font-size:24px;">🏆 ${roundName}</span>`; 
    }

    function renderPair(){
      updateRoundLabel();
      const a = current[pairIdx*2];
      const b = current[pairIdx*2+1];
      matchBox.innerHTML = cardHTML(a, 0) + cardHTML(b, 1);

      [...matchBox.querySelectorAll(".wc-card")].forEach((el, i) => {
        el.addEventListener("mouseover", () => {
          el.style.transform = "translateY(-8px) scale(1.02)";
          el.style.borderColor = "#3b82f6";
          el.style.boxShadow = "0 16px 48px rgba(59,130,246,.3)";
          el.querySelector('img').style.transform = "scale(1.05)";
        });
        el.addEventListener("mouseout", () => {
          el.style.transform = "translateY(0) scale(1)";
          el.style.borderColor = "#e5e7eb";
          el.style.boxShadow = "0 8px 32px rgba(0,0,0,.1)";
          el.querySelector('img').style.transform = "scale(1)";
        });

        el.addEventListener("click", () => {
          el.style.background = "linear-gradient(135deg,#3b82f6 0%,#1e40af 100%)";
          el.style.color = "white";
          el.style.transform = "scale(1.05)";
          el.style.borderColor = "#1e40af";
          const otherCard = el.parentNode.querySelector('.wc-card:not([data-idx="' + i + '"])');
          if (otherCard) { otherCard.style.opacity = "0.5"; otherCard.style.transform = "scale(0.95)"; }
          
          setTimeout(() => {
            winners.push(i === 0 ? a : b);
            pairIdx++;
            if (pairIdx >= current.length/2){
              if (winners.length === 1){
                matchBox.innerHTML = `
                  <div style="grid-column:1/-1;text-align:center;">
                    <div style="font-size:32px;font-weight:900;color:#1e3a8a;margin-bottom:24px;animation:bounce 1s infinite;">🏆 우승자 🏆</div>
                    <div style="max-width:400px;margin:0 auto;">${cardHTML(winners[0], 0)}</div>
                    <div style="margin-top:24px;padding:20px;background:linear-gradient(135deg,#dbeafe,#bfdbfe);border-radius:16px;border:2px solid #3b82f6;">
                      <div style="color:#1e3a8a;font-size:18px;font-weight:700;">축하합니다! 🎉</div>
                      <div style="color:#64748b;font-size:14px;margin-top:4px;">당신만의 향수를 찾았어요!</div>
                    </div>
                  </div>`;
                roundLabel.innerHTML = '<span style="color:#1e3a8a;font-size:28px;">👑 Champion 👑</span>';
                return;
              }
              current = winners.slice();
              winners = [];
              pairIdx = 0;
              round = current.length;
            }
            renderPair();
          }, 600);
        }, { once: true });
      });
    }
    renderPair();
  }

  if (startBtn){
    startBtn.addEventListener("click", (e) => {
      e.preventDefault(); e.stopPropagation();
      if (!CANDIDATES) {
        try { CANDIDATES = JSON.parse(document.getElementById('wc-data').textContent).slice(0, 16); }
        catch (_) { CANDIDATES = []; }
      }
      if (CANDIDATES.length < 2){
        alert("후보가 부족합니다. 왼쪽에서 조건을 선택해 주세요.");
        return;
      }
      if (panel) panel.style.minHeight = panel.offsetHeight + 'px';
      requestAnimationFrame(() => runTournament(CANDIDATES));
    });
  }

  // 바운스 애니메이션
  const style = document.createElement('style');
  style.textContent = `@keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0);}40%{transform:translateY(-10px);}60%{transform:translateY(-5px);}}`;
  document.head.appendChild(style);
  </script>
{% endblock script %}
