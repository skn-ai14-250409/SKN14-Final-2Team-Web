{% extends "scentpick/base.html" %}
{% block title %}ScentPick Chat{% endblock %}
{% block content %}
<div class="chat-container">

  <!-- ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ê°„ê²© ìµœì†Œí™” CSS -->
  <style>
    .markdown-body {
      white-space: pre-wrap !important;
      overflow-wrap: anywhere;
      word-break: keep-all;
      line-height: 1.4;
    }
    .markdown-body > * { margin: 0 !important; }
    .markdown-body > * + * { margin-top: 0.3em !important; }
    .markdown-body h1, .markdown-body h2, .markdown-body h3,
    .markdown-body h4, .markdown-body h5, .markdown-body h6 {
      margin: 0.4em 0 0.2em 0 !important;
      line-height: 1.2;
    }
    .markdown-body p { margin: 0.2em 0 !important; }
    .markdown-body ul, .markdown-body ol {
      margin: 0.2em 0 !important;
      padding-left: 1.2em;
    }
    .markdown-body li { margin: 0 !important; padding: 0.1em 0; }
    .markdown-body li > p { margin: 0 !important; display: inline; }
    .markdown-body blockquote {
      margin: 0.3em 0 !important;
      padding: 0.3em 0.6em;
      border-left: 3px solid #ddd;
      background: #f9f9f9;
    }
    .markdown-body pre {
      margin: 0.3em 0 !important;
      padding: 0.4em 0.6em;
      border-radius: 4px;
      background: #f6f8fa;
      overflow-x: auto;
    }
    .markdown-body code {
      padding: 0.1em 0.3em;
      background: #f0f0f0;
      border-radius: 3px;
    }
    .markdown-body pre code {
      padding: 0;
      background: transparent;
    }
    .markdown-body strong { font-weight: 600; }
    .markdown-body em { font-style: italic; }

    /* ì—…ë¡œë“œ ë²„íŠ¼ */
    .upload-btn {
      cursor: pointer;
      margin-right: 6px;
      display: flex;
      align-items: center;
    }
    .icon {
      width: 20px;
      height: 20px;
      stroke: #aaa;
    }

    /* ì…ë ¥ì°½ + ë¯¸ë¦¬ë³´ê¸° */
    .chat-input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .preview-wrapper {
      position: relative;
      width: 80px;
      height: 80px;
      margin-left: 6px; 
    }

    .preview-thumb {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 12px;
      cursor: pointer;
    }
  </style>

  <div class="chat-sidebar">
    <button class="new-chat-btn" id="newChatBtn">ìƒˆ ì±„íŒ…</button>
    <ul class="chat-history" id="chatHistory">
      {% if recent_conversations %}
        {% for conversation in recent_conversations %}
          <li class="conversation-item{% if conversation.id == current_conversation_id %} active{% endif %}"
              data-conversation-id="{{ conversation.id }}">
            {{ conversation.title|default:"ëŒ€í™”"|truncatechars:25 }}
          </li>
        {% endfor %}
      {% else %}
        <li class="no-conversations">ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
      {% endif %}
    </ul>
  </div>

  <div class="chat-main">
    <div class="chat-header">
      <h3 style="margin-bottom:10px;">ScentPick AI ì±—ë´‡</h3>
      <div class="chat-examples">ğŸ’¡ ì˜ˆì‹œ: "30ëŒ€ ë‚¨ìê°€ ìì£¼ ì°¾ëŠ” í–¥ìˆ˜ ì•Œë ¤ì¤˜", "ì½”íŠ¼ í–¥ì˜ 20ë§Œì› ì´í•˜ í–¥ìˆ˜"</div>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <!-- ì…ë ¥ì°½ + ë¯¸ë¦¬ë³´ê¸° -->
    <div class="chat-input-wrapper">
      <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
      <div id="previewWrapper" class="preview-wrapper" style="display:none;">
        <img id="previewImage" src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="preview-thumb"/>
        <button id="removeImage" class="remove-btn">âœ–</button>
      </div>

      <!-- ì…ë ¥ì°½ -->
      <div class="chat-input">
        <label for="imageUpload" class="upload-btn">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
        </label>
        <input id="imageUpload" type="file" accept="image/*" style="display:none;" />

        <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="chatInput" autocomplete="off">
        <button class="send-btn" id="chatSendBtn">ì „ì†¡</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked@13.0.3/marked.min.js"></script>
<script>
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const CSRF_TOKEN = getCookie('csrftoken');
  const SERVICE_TOKEN = "{{ SERVICE_TOKEN }}";

  let INITIAL_MESSAGES = [];
  try {
    const messagesData = '{{ chat_messages|escapejs }}';
    INITIAL_MESSAGES = (messagesData && messagesData !== '[]') ? JSON.parse(messagesData) : [];
  } catch (e) { INITIAL_MESSAGES = []; }

  (function () {
    const sendBtn = document.getElementById("chatSendBtn");
    const input   = document.getElementById("chatInput");
    const box     = document.getElementById("chatMessages");
    const newBtn  = document.getElementById("newChatBtn");
    const historyList = document.getElementById("chatHistory");

    const perfume_facts = [
      // ğŸª„ í–¥ìˆ˜ ê¸°ë³¸ ê°œë…
      "í†± ë…¸íŠ¸ëŠ” ë¿Œë¦¬ê³  10ë¶„ ë‚´ì— ëŠê»´ì§€ëŠ” ì²«ì¸ìƒì´ì—ìš”. ì‹œíŠ¸ëŸ¬ìŠ¤Â·í—ˆë¸Œ í–¥ì´ ë§ì•„ìš”!",
      "ë¯¸ë“¤(í•˜íŠ¸) ë…¸íŠ¸ëŠ” 30ë¶„~2ì‹œê°„ ì§€ì†ë˜ëŠ” ì¤‘ì‹¬ í–¥ì´ì—ìš”. í”Œë¡œëŸ´/ìŠ¤íŒŒì´ì‹œ ê³„ì—´ì´ ìì£¼ ì“°ì—¬ìš”.",
      "ë² ì´ìŠ¤ ë…¸íŠ¸ëŠ” ì”í–¥ ë‹¨ê³„ë¡œ, ìš°ë””Â·ë¨¸ìŠ¤í¬Â·ë°”ë‹ë¼ê°€ ì˜¤ë˜ ë‚¨ì•„ìš”.",
      "í¼í“¸(Extrait)ì€ ë†ë„ 20% ì´ìƒìœ¼ë¡œ í•˜ë£¨ ì¢…ì¼ ê°€ëŠ” ì§„í•œ íƒ€ì…ì´ì—ìš”.",
      "EDP(ì˜¤ ë“œ í¼í“¸)ëŠ” ì•½ 8ì‹œê°„ ì§€ì†ë¼ìš”. ë°ì¼ë¦¬ë¡œ ì œì¼ ë§ì´ ì“°ì—¬ìš”.",
      "EDT(ì˜¤ ë“œ ëšœì™ˆë ›)ëŠ” ê°€ë³ê³  ì‚°ëœ»í•´ì„œ 5ì‹œê°„ ì •ë„ ì§€ì†ë¼ìš”.",
      "EDC(ì˜¤ ë“œ ì½”ë¡±)ëŠ” ìƒì¾Œí•˜ì§€ë§Œ 2ì‹œê°„ ì •ë„ë©´ ì‚¬ë¼ì ¸ìš”.",
      "ë°”ë”” ë¯¸ìŠ¤íŠ¸ëŠ” ì€ì€í•˜ê²Œ 1~3% ë†ë„ë¡œ ê¸ˆë°© ì‚¬ë¼ì ¸ìš”.",
      "ë“œë¼ì´ ë‹¤ìš´ì€ ìµœì¢… ì”í–¥ìœ¼ë¡œ, ì²´ì·¨ì™€ ê°œì„±ì— ë”°ë¼ ë‹¬ë¼ì ¸ìš”.",
      "í–¥ìˆ˜ëŠ” ë³´í†µ í†±Â·ë¯¸ë“¤Â·ë² ì´ìŠ¤ 3ë‹¨ê³„ êµ¬ì¡°ë¡œ ì„¤ê³„ë¼ìš”.",

      // ğŸª„ ë³´ê´€ & ì‚¬ìš©ë²•
      "í–¥ìˆ˜ëŠ” í–‡ë¹›Â·ê³ ì˜¨ì„ í”¼í•˜ê³ , ì„œëŠ˜í•˜ê³  ì–´ë‘ìš´ ê³³ì— ë‘ëŠ” ê²Œ ì¢‹ì•„ìš”.",
      "ëƒ‰ì¥ ë³´ê´€ì€ í–¥ì„ ê¹¨ëœ¨ë¦´ ìˆ˜ ìˆì–´ì„œ ê¶Œì¥ë˜ì§€ ì•Šì•„ìš”.",
      "ê°œë´‰ í›„ ìœ íš¨ê¸°ê°„ì€ ë³´í†µ 1~3ë…„ì´ì—ìš”. ë¹›Â·ê³µê¸° ë…¸ì¶œì— ë”°ë¼ ë‹¬ë¼ì ¸ìš”.",
      "ë‚¨ì€ í–¥ìˆ˜ëŠ” í‚¤ì¹œíƒ€ì›”ì— í¡ìˆ˜ì‹œì¼œ ë²„ë¦¬ê³ , ìš©ê¸°ëŠ” ë¶„ë¦¬ë°°ì¶œí•˜ì„¸ìš”.",
      "ë¹„í–‰ê¸° ê¸°ë‚´ì—” 100ml ì´í•˜ë§Œ íˆ¬ëª… ì§€í¼ë°±ì— ë‹´ì•„ ê°€ì ¸ê°ˆ ìˆ˜ ìˆì–´ìš”.",
      "íœ´ëŒ€ìš© ì•„í†°ë¼ì´ì €ì— ë¦¬í•„í•˜ë©´ ì—¬í–‰í•  ë•Œ í¸ë¦¬í•´ìš”.",
      "ê³µì¤‘ì— ë¿Œë¦¬ê³  ì§€ë‚˜ê°€ë©´ ì˜·ê³¼ ë¨¸ë¦¬ì— ì€ì€í•˜ê²Œ ë‚¨ì•„ìš”.",
      "ë¨¸ë¦¬ì¹´ë½ì—” ë„ˆë¬´ ê°€ê¹Œì´ ë¿Œë¦¬ë©´ ê±´ì¡°í•´ì§€ë‹ˆ ì‚´ì§ ê±°ë¦¬ë¥¼ ë‘ì„¸ìš”.",
      "ì‹¤í¬Â·ê°€ì£½ì—” ì–¼ë£©ì§ˆ ìˆ˜ ìˆì–´ í”¼ë¶€ì— ë¿Œë¦¬ëŠ” ê²Œ ì•ˆì „í•´ìš”.",
      "ì§€ì„± í”¼ë¶€ê°€ ê±´ì„± í”¼ë¶€ë³´ë‹¤ í–¥ì´ ë” ì˜¤ë˜ ë‚¨ì•„ìš”.",

      // ğŸª„ ì‹œí–¥ & êµ¬ë§¤ íŒ
      "ë¸”ë¡œí„°(ì¢…ì´) ì‹œí–¥ì€ 1~2ë¶„ ë’¤ ë§¡ì•„ì•¼ ë” ì •í™•í•´ìš”.",
      "í”¼ë¶€ ì‹œí–¥ìœ¼ë¡œ ì²´ì·¨ì™€ ì–´ìš¸ë¦¬ëŠ”ì§€ ê¼­ í™•ì¸í•´ë³´ì„¸ìš”.",
      "í•œ ë²ˆì— 3~4ê°œ ì´ìƒ ì‹œí–¥í•˜ë©´ ì½”ê°€ ì‰½ê²Œ í”¼ê³¤í•´ì ¸ìš”.",
      "ì‹œí–¥ ì‚¬ì´ì—” ì›ë‘ ëƒ„ìƒˆë¥¼ ë§¡ìœ¼ë©´ ë„ì›€ì´ ë¼ìš”.",
      "ìƒ˜í”Œì„ ë©°ì¹ ê°„ ì¨ë³´ê³  ì •í’ˆì„ ì‚¬ë©´ ì‹¤íŒ¨ê°€ ì¤„ì–´ìš”.",
      "ì—¬ë¦„ì—” ì‹œíŠ¸ëŸ¬ìŠ¤/ì•„ì¿ ì•„, ê²¨ìš¸ì—” ìš°ë””/ì•°ë²„ê°€ ì˜ ì–´ìš¸ë ¤ìš”.",
      "ì˜¤í”¼ìŠ¤ì—” ì€ì€í•˜ê²Œ, ë°ì´íŠ¸ì—” ê´€ëŠ¥ì ì¸ í–¥ë„ ì¢‹ì•„ìš”.",
      "20ëŒ€ëŠ” ìƒí¼í•œ í”Œë¡œëŸ´, 30ëŒ€ ì´í›„ì—” ê¹Šì€ ìš°ë”” í–¥ì„ ì„ í˜¸í•˜ê¸°ë„ í•´ìš”.",
      "ìœ ë‹ˆì„¹ìŠ¤ í–¥ìˆ˜ëŠ” ì¤‘ì„±ì ì´ë¼ ëˆ„êµ¬ë‚˜ ì˜ ì–´ìš¸ë ¤ìš”.",
      "ì‹œê·¸ë‹ˆì²˜ í–¥ì„ ì •í•´ ê¾¸ì¤€íˆ ì“°ëŠ” ê²ƒë„ ë©‹ì ¸ìš” âœ¨",

      // ğŸª„ í–¥ìˆ˜ ì›ë£Œ & ì¡°í–¥
      "ì²œì—° ì›ë£ŒëŠ” ì¶”ì¶œ ë°©ì‹ì— ë”°ë¼ ê°€ê²©ì´ í¬ê²Œ ë‹¬ë¼ì ¸ìš”.",
      "í•©ì„± ì›ë£ŒëŠ” ëŒ€ëŸ‰ ìƒì‚° ê°€ëŠ¥í•˜ê³  ì•Œë ˆë¥´ê¸° ìœ„í—˜ë„ ì¤„ì—¬ì¤˜ìš”.",
      "ë¨¸ìŠ¤í¬ëŠ” ì§€ê¸ˆì€ ê±°ì˜ í•©ì„± ì›ë£Œë¥¼ ì¨ìš”.",
      "ì•°ë²„ëŠ” ê³¼ê±° ê³ ë˜ í–¥ìœ ì˜€ì§€ë§Œ, ì§€ê¸ˆì€ í•©ì„± ëŒ€ì²´í’ˆì„ ì¨ìš”.",
      "ìš°ë”” ê³„ì—´ì€ ìƒŒë‹¬ìš°ë“œÂ·ì‹œë”ìš°ë“œê°€ ëŒ€í‘œì ì´ì—ìš”.",
      "í”Œë¡œëŸ´ ê³„ì—´ì€ ì¥ë¯¸, ì¬ìŠ¤ë¯¼, ì¼ë‘ì¼ë‘ì´ ëŒ€í‘œì ì´ì—ìš”.",
      "ìŠ¤íŒŒì´ì‹œ ê³„ì—´ì€ ê³„í”¼Â·ì¹´ë‹¤ëª¸Â·í›„ì¶” ê°™ì€ í–¥ì‹ ë£Œì—ì„œ ë‚˜ì™€ìš”.",
      "ì‹œíŠ¸ëŸ¬ìŠ¤ ê³„ì—´ì€ ë ˆëª¬Â·ë² ë¥´ê°€ëª»Â·ì˜¤ë Œì§€ê°€ ë§ì•„ìš”.",
      "ì•„ì¿ ì•„ ê³„ì—´ì€ ë°”ë‹¤ ëŠë‚Œ ë‚˜ëŠ” í•©ì„± í–¥ë£Œì˜ˆìš”.",
      "êµ¬ë¥´ë§ ê³„ì—´ì€ ë°”ë‹ë¼Â·ì´ˆì½œë¦¿Â·ì»¤í”¼ ê°™ì€ ë‹¬ì½¤í•œ í–¥ì´ì—ìš”.",

      // ğŸª„ í–¥ìˆ˜ ë¬¸í™” & íŠ¸ë Œë“œ
      "ë‹ˆì¹˜ í–¥ìˆ˜ëŠ” ë…ì°½ì„±ê³¼ ê°œì„±ì„ ê°•ì¡°í•˜ëŠ” ì†Œê·œëª¨ ë¸Œëœë“œì˜ˆìš”.",
      "ë¹ˆí‹°ì§€ í–¥ìˆ˜ëŠ” ë‹¨ì¢…ë¼ì„œ ìˆ˜ì§‘ê°€ë“¤í•œí…Œ ì¸ê¸°ê°€ ë§ì•„ìš”.",
      "ì»¤í”Œ í–¥ìˆ˜ëŠ” ê°™ì€ ì½˜ì…‰íŠ¸ë¡œ ë‚¨ë…€ìš©ì„ í•¨ê»˜ ì¶œì‹œí•´ìš”.",
      "í•œì •íŒ í–¥ìˆ˜ëŠ” ì‹œì¦ŒÂ·ì½œë¼ë³´ ì œí’ˆìœ¼ë¡œ ì†Œì¥ ê°€ì¹˜ê°€ ë†’ì•„ìš”.",
      "í–¥ì€ ê¸°ì–µê³¼ ê°ì •ì— ì—°ê²°ë¼ ê¸°ë¶„ì„ ë°”ê¾¸ëŠ” í˜ì´ ìˆì–´ìš”.",
      "ë°€íëœ ê³µê°„ì—ì„œ í–¥ìˆ˜ë¥¼ ê³¼í•˜ê²Œ ë¿Œë¦¬ë©´ ë§¤ë„ˆ ìœ„ë°˜ì´ì—ìš”.",
      "ë ˆì´ì–´ë§ìœ¼ë¡œ ìì‹ ë§Œì˜ í–¥ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ìš” âœ¨",
      "í¼í“¸ ì˜¤ì¼ì€ ì•Œì½”ì˜¬ì´ ì ì–´ í”¼ë¶€ì— ìˆœí•˜ê³  ì˜¤ë˜ê°€ìš”.",
      "í–¥ìˆ˜ ê°€ê²©ì—” ì›ë£Œ ì™¸ì—ë„ ë””ìì¸Â·ë¸Œëœë“œ ì´ë¯¸ì§€ê°€ í¬ê²Œ ë°˜ì˜ë¼ìš”.",
      "ìµœê·¼ í–¥ìˆ˜ íŠ¸ë Œë“œëŠ” ì  ë”ë¦¬ìŠ¤Â·ì§€ì†ê°€ëŠ¥ì„±Â·ì²œì—° ì›ë£Œì˜ˆìš”."
    ];

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ/ë¯¸ë¦¬ë³´ê¸°
    const fileInput = document.getElementById("imageUpload");
    const previewWrapper = document.getElementById("previewWrapper");
    const previewImage = document.getElementById("previewImage");
    const removeImage = document.getElementById("removeImage");
    let uploadedFile = null;

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // í—ˆìš© í™•ì¥ì ëª©ë¡
      const allowedExtensions = ["jpg", "jpeg", "png", "gif"];
      const maxSize = 5 * 1024 * 1024; // 5MB

      // íŒŒì¼ í™•ì¥ì í™•ì¸
      const ext = file.name.split(".").pop().toLowerCase();
      if (!allowedExtensions.includes(ext)) {
        showToast("ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤. (í—ˆìš©: JPG, JPEG, PNG, GIF)", "error");
        fileInput.value = "";
        uploadedFile = null;
        return;
      }

      // íŒŒì¼ í¬ê¸° í™•ì¸
      if (file.size > maxSize) {
        showToast("ì´ë¯¸ì§€ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.", "error");
        fileInput.value = "";
        uploadedFile = null;
        return;
      }

      // í†µê³¼ ì‹œ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
      uploadedFile = file;
      const reader = new FileReader();
      reader.onload = (e) => {
        previewImage.src = e.target.result;
        previewWrapper.style.display = "block";
      };
      reader.readAsDataURL(file);
    });
    
    removeImage.addEventListener("click", () => {
      uploadedFile = null;
      fileInput.value = "";
      previewWrapper.style.display = "none";
    });

    // ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ì´ˆê¸° ì»¨í…ìŠ¤íŠ¸
    let conversationId = {% if current_conversation_id %}{{ current_conversation_id }}{% else %}null{% endif %};
    let externalThreadId = {% if external_thread_id %}"{{ external_thread_id }}"{% else %}null{% endif %};

    // ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadConversations() {
      try {
        const resp = await fetch("{% url 'scentpick:conversations_api' %}", {
          method: "GET",
          headers: { "X-CSRFToken": CSRF_TOKEN, "X-Service-Token": SERVICE_TOKEN }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        historyList.innerHTML = '';
        if (data.items && data.items.length > 0) {
          data.items.forEach(conv => {
            const li = document.createElement("li");
            li.className = "conversation-item";
            if (conv.id == conversationId) li.className += " active";
            li.dataset.conversationId = conv.id;
            li.textContent = conv.title || `ëŒ€í™” ${conv.id}`;
            li.addEventListener('click', () => window.loadConversation(conv.id));
            historyList.appendChild(li);
          });
        } else {
          historyList.innerHTML = '<li class="no-conversations">ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        }
      } catch (e) {
        console.error('ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        historyList.innerHTML = '<li class="error">ëŒ€í™” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>';
      }
    }

    // íŠ¹ì • ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸°
    window.loadConversation = async function(convId) {
      try {
        document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
        const act = document.querySelector(`[data-conversation-id="${convId}"]`);
        if (act) act.classList.add('active');

        const resp = await fetch(`{% url 'scentpick:conversation_messages_api' conv_id=0 %}`.replace('0', convId), {
          method: "GET",
          headers: { "X-CSRFToken": CSRF_TOKEN, "X-Service-Token": SERVICE_TOKEN }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const data = await resp.json();
        conversationId = data.conversation_id;
        box.innerHTML = '';

        if (data.items && data.items.length > 0) {
          data.items.forEach(msg => {
            const el = addMessage(msg.content, msg.role === 'user', true, msg.chat_image);
            if (msg.role === 'assistant' && msg.perfume_list && msg.perfume_list.length > 0) {
              addPerfumeRecommendations(el.wrap, msg.perfume_list);
            }
          });
        } else {
          console.log('ë©”ì‹œì§€ê°€ ì—†ìŒ');
          addMessage("ì´ ëŒ€í™”ì—ëŠ” ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.", false, false);
        }
      } catch (e) {
        console.error('ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        if (e.message && !e.message.includes('404')) {
          addMessage(`ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, false, false);
        }
      }
    }

    // ìƒˆ ì±„íŒ… ì‹œì‘
    async function startNewChat() {
      try {
        const resp = await fetch("{% url 'scentpick:chat_new_api' %}", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": CSRF_TOKEN }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        conversationId = null;
        externalThreadId = data.external_thread_id;

        box.innerHTML = "";
        addMessage("ì•ˆë…•í•˜ì„¸ìš”! ScentPick AIì…ë‹ˆë‹¤. ì–´ë–¤ í–¥ìˆ˜ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?", false, false);
        document.querySelectorAll('.conversation-item').forEach(i => i.classList.remove('active'));
        input.focus();
      } catch (e) {
        console.error('ìƒˆ ì±„íŒ… ì‹œì‘ ì‹¤íŒ¨:', e);
        addMessage(`ìƒˆ ì±„íŒ…ì„ ì‹œì‘í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, false, false);
      }
    }

    function renderMarkdown(text) {
      try {
        if (typeof marked === 'undefined') return (text ?? '').replace(/\n/g, '<br>');
        marked.setOptions({ gfm: true, breaks: true, headerIds: false, mangle: false, sanitize: false });
        return marked.parse((text ?? '').replace(/\\n/g, '\n'));
      } catch (e) { return (text ?? '').replace(/\n/g, '<br>'); }
    }

    function addMessage(msg, isUser = false, useMarkdown = true, imageUrl = null) {
      const wrap  = document.createElement("div");
      wrap.className = "message" + (isUser ? " user" : "");

      // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ë¨¼ì € ì´ë¯¸ì§€ ì¶”ê°€
      if (imageUrl) {
        const imgDiv = document.createElement("div");
        imgDiv.className = "message-image";
        imgDiv.innerHTML = `<img src="${imageUrl}" alt="ì—…ë¡œë“œëœ ì´ë¯¸ì§€" style="max-width: 300px; max-height: 300px; border-radius: 8px; margin-bottom: 8px;">`;
        wrap.appendChild(imgDiv);
      }

      // í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì¶”ê°€
      if (msg && msg.trim()) {
        const inner = document.createElement("div");
        inner.className = "message-content";
        inner.innerHTML = useMarkdown ? renderMarkdown(msg) : msg;
        wrap.appendChild(inner);
      }

      box.appendChild(wrap);
      box.scrollTop = box.scrollHeight;
      return { wrap, inner: wrap.querySelector('.message-content') };
    }

    function addPerfumeRecommendations(messageWrap, perfumes) {
      if (!perfumes || perfumes.length === 0) return;
      const div = document.createElement("div");
      div.className = "perfume-recommendations";
      perfumes.slice(0, 5).forEach(p => {
        const btn = document.createElement("button");
        btn.className = "perfume-btn";
        btn.textContent = `${p.brand} - ${p.name}`;
        btn.onclick = () => { window.location.href = `/perfume/${p.id}/`; };
        div.appendChild(btn);
      });
      messageWrap.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    function addLoading() {
      const fact = perfume_facts[Math.floor(Math.random() * perfume_facts.length)];
      return addMessage(`ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”...<br>ğŸ’¡ TIP: ${fact}`, false, false);
    }

    async function send() {
      const txt = (input.value || "").trim();
      if (!txt && !uploadedFile) return;

      // ì „ì†¡í•  ê°’ ë¯¸ë¦¬ ë°±ì—…
      const sendText = txt;
      const sendImage = uploadedFile;

      const userImageUrl = sendImage ? previewImage.src : null;
      addMessage(sendText, true, false, userImageUrl);

      let fullText = "";  // ì „ì²´ ì‘ë‹µ ëˆ„ì ìš©

      // ë²„íŠ¼ ëˆ„ë¥´ëŠ” ìˆœê°„ ì…ë ¥ì°½/ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
      input.value = "";                     
      previewWrapper.style.display = "none";

      sendBtn.disabled = true;
      input.disabled = true;
      const loader = addLoading();

      try {
        const formData = new FormData();
        formData.append("content", sendText);
        if (sendImage) formData.append("image", sendImage);

        // conversation_id ìœ ì§€í•´ì„œ ë³´ë‚´ê¸°
        if (conversationId) {
          formData.append("conversation_id", conversationId);
        }

        const response = await fetch("{% url 'scentpick:chat_stream_api' %}", {
          method: "POST",
          headers: { "X-CSRFToken": CSRF_TOKEN, "X-Service-Token": SERVICE_TOKEN },
          body: formData
        });

        if (!response.ok) {
          loader.inner.innerHTML = renderMarkdown(`ì˜¤ë¥˜: HTTP ${response.status}`);
          return;
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let currentContent = '';
        let firstChunk = true; 

        loader.inner.classList.add("markdown-body");

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const text = decoder.decode(value, { stream: true });
          const lines = text.split('\n');

          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            try {
              const data = JSON.parse(line.slice(6));
              if (data.error) {
                loader.inner.innerHTML = renderMarkdown(`ì˜¤ë¥˜: ${data.error}`);
                return;
              }
              if (data.content) {
                if (firstChunk) {
                  loader.inner.innerHTML = "";
                  loader.inner.classList.add("markdown-body");
                  firstChunk = false;
                }

                // ì „ì²´ í…ìŠ¤íŠ¸ ëˆ„ì 
                fullText += data.content;

                // ë°›ì€ chunkë¥¼ ê¸€ì ë‹¨ìœ„ë¡œ ìª¼ê°œê¸°
                for (const char of data.content) {
                  await new Promise(resolve => setTimeout(resolve, 20)); // ê¸€ìë‹¹ 20ms ë”œë ˆì´
                  const span = document.createElement("span");
                  span.textContent = char;
                  loader.inner.appendChild(span);
                  box.scrollTop = box.scrollHeight;
                }
              }
              if (data.done) {
                if (data.conversation_id) {
                  conversationId = data.conversation_id;
                }
                if (data.perfume_list && data.perfume_list.length > 0) {
                  addPerfumeRecommendations(loader.wrap, data.perfume_list);
                }

                // ìŠ¤íŠ¸ë¦¬ë°ì´ ëë‚˜ë©´ ì „ì²´ë¥¼ ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ìœ¼ë¡œ êµì²´
                loader.inner.innerHTML = renderMarkdown(fullText);

                return;
              }
            } catch (e) { console.error("íŒŒì‹± ì˜¤ë¥˜:", e, line); }
          }
        }
      } catch (e) {
        loader.inner.innerHTML = renderMarkdown(`ì˜¤ë¥˜: ${e.message}`);
      } finally {
        // ì „ì†¡ ëë‚œ í›„ ì—…ë¡œë“œ ìƒíƒœë§Œ ì´ˆê¸°í™”
        uploadedFile = null;
        fileInput.value = "";

        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keypress", (e) => { if (e.key === "Enter") send(); });
    newBtn.addEventListener("click", startNewChat);

    // ì´ˆê¸° ë©”ì‹œì§€ ë³µì›
    if (INITIAL_MESSAGES && INITIAL_MESSAGES.length > 0) {
      INITIAL_MESSAGES.forEach(msg => {
        const el = addMessage(msg.content, msg.role === 'user', true, msg.chat_image);
        if (msg.role === 'assistant' && msg.perfume_list) {
          addPerfumeRecommendations(el.wrap, msg.perfume_list);
        }
      });
    } else {
      addMessage("ì•ˆë…•í•˜ì„¸ìš”! ScentPick AIì…ë‹ˆë‹¤. ì–´ë–¤ í–¥ìˆ˜ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?", false, false);
    }

    // ê¸°ì¡´ ëŒ€í™” í•­ëª©ë“¤ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.querySelectorAll('.conversation-item[data-conversation-id]').forEach(item => {
      item.addEventListener('click', () => {
        const convId = parseInt(item.dataset.conversationId);
        window.loadConversation(convId);
      });
    });

  })();
</script>
{% endblock %}