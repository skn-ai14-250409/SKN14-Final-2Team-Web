{% extends "scentpick/base.html" %}
{% block title %}ScentPick Chat{% endblock %}
{% block content %}
<div class="chat-container">

  <!-- ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ê°„ê²© ìµœì†Œí™” CSS -->
  <style>
    /* ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë Œë”ë˜ëŠ” AI ë©”ì‹œì§€ ì „ìš© */
    .markdown-body {
      white-space: pre-wrap !important;
      overflow-wrap: anywhere;
      word-break: keep-all;
      line-height: 1.4;
    }
    
    /* ëª¨ë“  ìš”ì†Œì˜ ë§ˆì§„ ìµœì†Œí™” */
    .markdown-body > * { margin: 0 !important; }
    .markdown-body > * + * { margin-top: 0.3em !important; }
    
    /* í—¤ë”© ê°„ê²© ì¡°ì • */
    .markdown-body h1, .markdown-body h2, .markdown-body h3, 
    .markdown-body h4, .markdown-body h5, .markdown-body h6 { 
      margin: 0.4em 0 0.2em 0 !important; 
      line-height: 1.2;
    }
    
    /* ë¬¸ë‹¨ê³¼ ë¦¬ìŠ¤íŠ¸ ê°„ê²© ìµœì†Œí™” */
    .markdown-body p { margin: 0.2em 0 !important; }
    .markdown-body ul, .markdown-body ol { 
      margin: 0.2em 0 !important; 
      padding-left: 1.2em; 
    }
    .markdown-body li { margin: 0 !important; padding: 0.1em 0; }
    .markdown-body li > p { margin: 0 !important; display: inline; }
    
    /* ì¸ìš©êµ¬ ê°„ê²© ì¡°ì • */
    .markdown-body blockquote { 
      margin: 0.3em 0 !important; 
      padding: 0.3em 0.6em; 
      border-left: 3px solid #ddd;
      background: #f9f9f9;
    }
    .markdown-body blockquote p { margin: 0 !important; }
    
    /* ì½”ë“œë¸”ë¡ ê°„ê²© ì¡°ì • */
    .markdown-body pre { 
      margin: 0.3em 0 !important; 
      padding: 0.4em 0.6em; 
      border-radius: 4px; 
      background: #f6f8fa; 
      overflow-x: auto;
    }
    .markdown-body code { 
      padding: 0.1em 0.3em; 
      background: #f0f0f0; 
      border-radius: 3px; 
    }
    .markdown-body pre code { 
      padding: 0; 
      background: transparent; 
    }
    
    /* ê°•ì¡° í‘œì‹œ */
    .markdown-body strong { font-weight: 600; }
    .markdown-body em { font-style: italic; }
  </style>

  <div class="chat-sidebar">
    <button class="new-chat-btn" id="newChatBtn">ìƒˆ ì±„íŒ…</button>
    <ul class="chat-history" id="chatHistory">
      {% if recent_conversations %}
        {% for conversation in recent_conversations %}
          <li class="conversation-item{% if conversation.id == current_conversation_id %} active{% endif %}" 
              data-conversation-id="{{ conversation.id }}"
              onclick="loadConversation({{ conversation.id }})">
            {{ conversation.title|default:"ëŒ€í™”"|truncatechars:25 }}
          </li>
        {% endfor %}
      {% else %}
        <li class="no-conversations">ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
      {% endif %}
    </ul>
  </div>

  <div class="chat-main">
    <div class="chat-header">
      <h3 style="margin-bottom:10px;">ScentPick AI ì±—ë´‡</h3>
      <div class="chat-examples">ğŸ’¡ ì˜ˆì‹œ: "30ëŒ€ ë‚¨ìê°€ ìì£¼ ì°¾ëŠ” í–¥ìˆ˜ ì•Œë ¤ì¤˜", "ì½”íŠ¼ í–¥ì˜ 20ë§Œì› ì´í•˜ í–¥ìˆ˜"</div>
    </div>

    <div class="chat-messages" id="chatMessages"></div>

    <div class="chat-input">
      <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="chatInput" autocomplete="off">
      <button class="send-btn" id="chatSendBtn">ì „ì†¡</button>
    </div>
  </div>

</div>
{% endblock content %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/marked@13.0.3/marked.min.js"></script>
<script>
  // CSRF í† í°
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const CSRF_TOKEN = getCookie('csrftoken');
  const SERVICE_TOKEN = "{{ SERVICE_TOKEN }}";

  // ì´ˆê¸° ë©”ì‹œì§€ (ì„œë²„ ì£¼ì…)
  let INITIAL_MESSAGES = [];
  try {
    const messagesData = '{{ chat_messages|escapejs }}';
    INITIAL_MESSAGES = (messagesData && messagesData !== '[]') ? JSON.parse(messagesData) : [];
  } catch (e) {
    console.error('ì´ˆê¸° ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', e);
    INITIAL_MESSAGES = [];
  }

  (function () {
    const sendBtn = document.getElementById("chatSendBtn");
    const input   = document.getElementById("chatInput");
    const box     = document.getElementById("chatMessages");
    const newBtn  = document.getElementById("newChatBtn");
    const historyList = document.getElementById("chatHistory");
    if (!sendBtn || !input || !box || !historyList) return;

    // âœ… ì¹œì ˆí•œ ë¡œë”© ë©˜íŠ¸ìš© í–¥ìˆ˜ íŒ©íŠ¸ (ëœë¤)
    const perfume_facts = [
      "í†± ë…¸íŠ¸ëŠ” ë¿Œë¦¬ê³  10ë¶„ ë‚´ì— ëŠê»´ì§€ëŠ” ì²«ì¸ìƒì´ì—ìš”. ìƒí¼í•œ ì‹œíŠ¸ëŸ¬ìŠ¤ê°€ ë§ì•„ìš”!",
      "ë¯¸ë“¤(í•˜íŠ¸) ë…¸íŠ¸ëŠ” 30ë¶„~2ì‹œê°„ ì§€ì†ë˜ëŠ” ì¤‘ì‹¬ í–¥ì´ì—ìš”. í”Œë¡œëŸ´/ìŠ¤íŒŒì´ì‹œê°€ ìì£¼ ì“°ì—¬ìš”.",
      "ë² ì´ìŠ¤ ë…¸íŠ¸ëŠ” ì”í–¥ ë‹¨ê³„ë¡œ ìš°ë””Â·ë¨¸ìŠ¤í¬Â·ë°”ë‹ë¼ê°€ ì˜¤ë˜ ë‚¨ì•„ìš”.",
      "í¼í“¸(Extrait)ì€ ë†ë„ 20%+ë¡œ ê°€ì¥ ì§„í•˜ê³  ì˜¤ë˜ ê°‘ë‹ˆë‹¤.",
      "EDP(ì˜¤ ë“œ í¼í“¸)ëŠ” ë³´í†µ 8ì‹œê°„ ì•ˆíŒ, ë°ì¼ë¦¬ë¡œ ì œì¼ ë§ì´ ì“°ì—¬ìš”.",
      "EDT(ì˜¤ ë“œ ëšœì™ˆë ›)ëŠ” ê°€ë³ê³  ì‚°ëœ», ì•½ 5ì‹œê°„ ì •ë„ ì§€ì†ë¼ìš”.",
      "EDC(ì˜¤ ë“œ ì½”ë¡±)ëŠ” ìƒì¾Œí•˜ì§€ë§Œ 2ì‹œê°„ ë‚´ì™¸ë¡œ ê¸ˆë°© ì‚¬ë¼ì ¸ìš”.",
      "í–¥ìˆ˜ëŠ” ì§ì‚¬ê´‘ì„ ê³¼ ê³ ì˜¨ì„ í”¼í•˜ê³ , ì„œëŠ˜í•˜ê³  ì–´ë‘ìš´ ê³³ì— ë³´ê´€í•˜ì„¸ìš”.",
      "ê°œë´‰ í›„ ìœ íš¨ê¸°ê°„ì€ í‰ê·  1~3ë…„ì´ì—ìš”. ë¹›/ê³µê¸° ë…¸ì¶œì´ ê´€ê±´!",
      "ë¹„í–‰ê¸° ë°˜ì…ì€ 100ml ì´í•˜ë§Œ íˆ¬ëª… ì§€í¼ë°±ì— ë„£ì–´ì•¼ í•´ìš”.",
      "ê³µì¤‘ì— ë¿Œë¦¬ê³  ì§€ë‚˜ê°€ë©´ ì˜·ê³¼ ë¨¸ë¦¬ì— ì€ì€í•˜ê²Œ ë‚¨ì•„ìš”.",
      "ë¨¸ë¦¬ì¹´ë½ì—” ë„ˆë¬´ ê°€ê¹Œì´ ë¿Œë¦¬ë©´ ê±´ì¡°í•´ì§ˆ ìˆ˜ ìˆì–´ìš”. ì‚´ì§ ê±°ë¦¬ ë‘ê¸°!",
      "ë¸”ë¡œí„°(ì¢…ì´) ì‹œí–¥ì€ 1~2ë¶„ ë’¤ ë§¡ìœ¼ë©´ ë” ì •í™•í•´ìš”.",
      "í”¼ë¶€ ì‹œí–¥ìœ¼ë¡œ ì²´ì·¨ì™€ ì–´ìš¸ë¦¼ì„ ê¼­ í™•ì¸í•´ë³´ì„¸ìš”.",
      "í•œ ë²ˆì— 3~4ê°œ ì´ìƒ ì‹œí–¥í•˜ë©´ í›„ê°ì´ ì‰½ê²Œ í”¼ê³¤í•´ì ¸ìš”.",
      "ìƒ˜í”Œë¡œ ë©°ì¹  ì¨ë³´ê³  ì •í’ˆ êµ¬ë§¤í•˜ë©´ ì‹¤íŒ¨ê°€ ì¤„ì–´ìš”.",
      "ì—¬ë¦„ì—” ì‹œíŠ¸ëŸ¬ìŠ¤/ì•„ì¿ ì•„, ê²¨ìš¸ì—” ìš°ë””/ì•°ë²„ê°€ ì˜ ì–´ìš¸ë ¤ìš”.",
      "ì˜¤í”¼ìŠ¤ì—” ì€ì€í•˜ê²Œ, ë°ì´íŠ¸ì—” ì¡°ê¸ˆ ë” ê´€ëŠ¥ì ì¸ í–¥ë„ ì¢‹ì•„ìš”.",
      "ë¨¸ìŠ¤í¬ëŠ” ì§€ê¸ˆì€ ëŒ€ë¶€ë¶„ í•©ì„± ì›ë£Œë¥¼ ì‚¬ìš©í•´ìš”.",
      "ë ˆì´ì–´ë§ìœ¼ë¡œ ìì‹ ë§Œì˜ ì‹œê·¸ë‹ˆì²˜ í–¥ì„ ë§Œë“¤ ìˆ˜ ìˆì–´ìš” âœ¨"
    ];

    // ì„œë²„ì—ì„œ ë‚´ë ¤ì¤€ ì´ˆê¸° ì»¨í…ìŠ¤íŠ¸
    let conversationId   = {{ conversation_id|default:"null" }};
    let externalThreadId = {% if external_thread_id %}"{{ external_thread_id }}"{% else %}null{% endif %};

    // ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadConversations() {
      try {
        const resp = await fetch("{% url 'scentpick:conversations_api' %}", {
          method: "GET",
          headers: { "X-CSRFToken": CSRF_TOKEN, "X-Service-Token": SERVICE_TOKEN }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        historyList.innerHTML = '';
        if (data.items && data.items.length > 0) {
          data.items.forEach(conv => {
            const li = document.createElement("li");
            li.className = "conversation-item";
            li.dataset.conversationId = conv.id;
            li.textContent = conv.title || `ëŒ€í™” ${conv.id}`;
            li.addEventListener('click', () => window.loadConversation(conv.id));
            historyList.appendChild(li);
          });
        } else {
          historyList.innerHTML = '<li class="no-conversations">ì•„ì§ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
        }
      } catch (e) {
        console.error('ëŒ€í™” ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        historyList.innerHTML = '<li class="error">ëŒ€í™” ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</li>';
      }
    }

    // íŠ¹ì • ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸°
    window.loadConversation = async function(convId) {
      try {
        document.querySelectorAll('.conversation-item').forEach(item => item.classList.remove('active'));
        const act = document.querySelector(`[data-conversation-id="${convId}"]`);
        if (act) act.classList.add('active');

        const resp = await fetch(`/api/conversations/${convId}/messages`, {
          method: "GET",
          headers: { "X-CSRFToken": CSRF_TOKEN, "X-Service-Token": SERVICE_TOKEN, }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

        const data = await resp.json();
        conversationId = data.conversation_id;
        box.innerHTML = '';

        if (data.items && data.items.length > 0) {
          data.items.forEach(msg => {
            const el = addMessage(msg.content, msg.role === 'user');
            if (msg.role === 'assistant' && msg.perfume_list && msg.perfume_list.length > 0) {
              addPerfumeRecommendations(el.wrap, msg.perfume_list);
            }
          });
        } else {
          addMessage("ì´ ëŒ€í™”ì—ëŠ” ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.", false, false);
        }
      } catch (e) {
        console.error('ëŒ€í™” ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
        if (e.message && !e.message.includes('404')) {
          addMessage(`ëŒ€í™”ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, false, false);
        }
      }
    }

    // ìƒˆ ì±„íŒ… ì‹œì‘
    async function startNewChat() {
      try {
        const resp = await fetch("{% url 'scentpick:chat_new_api' %}", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRFToken": CSRF_TOKEN, "X-Service-Token": SERVICE_TOKEN }
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();

        conversationId = null;
        externalThreadId = data.external_thread_id;

        box.innerHTML = "";
        addMessage("ì•ˆë…•í•˜ì„¸ìš”! ScentPick AIì…ë‹ˆë‹¤. ì–´ë–¤ í–¥ìˆ˜ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?", false, false);
        document.querySelectorAll('.conversation-item').forEach(i => i.classList.remove('active'));
        input.focus();
      } catch (e) {
        console.error('ìƒˆ ì±„íŒ… ì‹œì‘ ì‹¤íŒ¨:', e);
        addMessage(`ìƒˆ ì±„íŒ…ì„ ì‹œì‘í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, false, false);
      }
    }

    // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ (ê°œí–‰ ìµœì†Œí™”)
    function renderMarkdown(text) {
      try {
        if (typeof marked === 'undefined') return (text ?? '').replace(/(?:\r\n|\r|\n)/g, '<br>');

        marked.setOptions({
          gfm: true,
          breaks: true,      // FastAPI ì‘ë‹µ ê°œí–‰ì„ <br>ë¡œ ìœ ì§€
          headerIds: false,
          mangle: false,
          sanitize: false
        });

        const preprocessed = (text ?? '')
          .replace(/\r\n/g, '\n')           // CRLFë¥¼ LFë¡œ í†µì¼
          .replace(/\r/g, '\n')               // ë‹¨ë… CRë„ LFë¡œ ë³€í™˜
          .replace(/\\n/g, '\n');          // FastAPI ì‘ë‹µì˜ \nì„ ì‹¤ì œ ê°œí–‰ìœ¼ë¡œ

        let rendered = marked.parse(preprocessed);

        if (!rendered.includes('<br') && preprocessed.includes('\n')) {
          rendered = preprocessed
            .split('\n')
            .map(line => marked.parseInline(line) || '')
            .join('<br>');
        }

        rendered = rendered
          .replace(/>\s+</g, '><')
          .trim();

        return rendered;
      } catch (e) {
        console.error('ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì˜¤ë¥˜:', e);
        return (text ?? '').replace(/(?:\r\n|\r|\n)/g, '<br>');
      }
    }

    function addMessage(msg, isUser = false, useMarkdown = true) {
      const wrap  = document.createElement("div");
      wrap.className = "message" + (isUser ? " user" : "");
      const inner = document.createElement("div");
      inner.className = "message-content";

      if (isUser || !useMarkdown) {
        inner.textContent = msg;
      } else {
        inner.classList.add("markdown-body");
        inner.innerHTML = renderMarkdown(msg);
      }

      wrap.appendChild(inner);
      box.appendChild(wrap);
      box.scrollTop = box.scrollHeight;
      return { wrap, inner };
    }

    // ì¶”ì²œ ë²„íŠ¼
    function addPerfumeRecommendations(messageWrap, perfumes) {
      if (!perfumes || perfumes.length === 0) return;
      const div = document.createElement("div");
      div.className = "perfume-recommendations";
      perfumes.slice(0, 5).forEach(p => {
        const btn = document.createElement("button");
        btn.className = "perfume-btn";
        btn.textContent = `${p.brand} - ${p.name}`;
        btn.onclick = () => { window.location.href = `/perfume/${p.id}/`; };
        div.appendChild(btn);
      });
      messageWrap.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    // âœ… ë¡œë”© ë©”ì‹œì§€: ì¹œì ˆí•œ íŒì„ í•¨ê»˜ í‘œê¸°
    function addLoading() {
      const fact = perfume_facts[Math.floor(Math.random() * perfume_facts.length)];
      return addMessage(`ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”...\nğŸ’¡ TIP: ${fact}`, false, false);
    }

    async function send() {
      const txt = (input.value || "").trim();
      if (!txt) return;

      input.value = "";
      addMessage(txt, true);
      sendBtn.disabled = true;
      input.disabled = true;
      const loader = addLoading(); // ë¡œë”© ì•ˆë‚´ë§Œ í‘œì‹œ
      let loader = null; // ë‹µë³€ ì»¨í…Œì´ë„ˆëŠ” ë”°ë¡œ ìƒì„±

      try {
        // EventSourceë¥¼ ì‚¬ìš©í•œ ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹
        const streamUrl = "{% url 'scentpick:chat_stream_api' %}";

        // POST ë°ì´í„°ë¥¼ URL íŒŒë¼ë¯¸í„°ë¡œ ì „ì†¡ (EventSourceëŠ” POSTë¥¼ ì§ì ‘ ì§€ì›í•˜ì§€ ì•ŠìŒ)
        // ëŒ€ì‹  fetchë¡œ ìŠ¤íŠ¸ë¦¬ë° ìš”ì²­
        const response = await fetch(streamUrl, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": CSRF_TOKEN,
            "Accept": "text/event-stream",
            "X-Service-Token": SERVICE_TOKEN
          },
          body: JSON.stringify({ content: txt, conversation_id: conversationId || null })
        });

        if (!response.ok) {
          loader.inner.innerHTML = renderMarkdown(`ì˜¤ë¥˜: HTTP ${response.status}`);
          return;
        }

        // ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ì²˜ë¦¬
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let currentContent = '';

        // ë¡œë”© ë©”ì‹œì§€ ì œê±° í›„ ìƒˆ ë‹µë³€ ë©”ì‹œì§€ ìƒì„±
        loadingMsg.wrap.remove();
        loader = addMessage("", false, false);
        loader.inner.classList.add("markdown-body");

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });

          // SSE í˜•ì‹ íŒŒì‹± (data: ... í˜•íƒœ)
          const lines = buffer.split('\n');
          buffer = lines.pop() || ''; // ë§ˆì§€ë§‰ ë¯¸ì™„ì„± ë¼ì¸ì€ ë²„í¼ì— ë³´ê´€

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const data = JSON.parse(line.slice(6));

                if (data.error) {
                  loader.inner.innerHTML = renderMarkdown(`ì˜¤ë¥˜: ${data.error}`);
                  return;
                }

                if (data.content) {
                  // ì•½ê°„ì˜ ì§€ì—° â†’ íƒ€ì ì¹˜ëŠ” ë“¯í•œ íš¨ê³¼
                  await new Promise(resolve => setTimeout(resolve, 50));

                  // 1) ìŠ¤íŠ¸ë¦¬ë° ì¤‘: ì²­í¬ ê·¸ëŒ€ë¡œ spanì— ì¶œë ¥ (ë§ˆí¬ë‹¤ìš´ ë¬´ì‹œ)
                  const span = document.createElement("span");
                  span.textContent = data.content;   // ë§ˆí¬ë‹¤ìš´ ì ìš© ì•ˆí•¨
                  loader.inner.appendChild(span);
                  box.scrollTop = box.scrollHeight;

                  // 2) ì „ì²´ ë¬¸ìì—´ ëˆ„ì 
                  currentContent += data.content;
                }

                if (data.done) {
                  // 3) ìµœì¢…ì ìœ¼ë¡œ ì „ì²´ ë‹µë³€ì„ ë§ˆí¬ë‹¤ìš´ìœ¼ë¡œ ë³€í™˜
                  loader.inner.classList.add("markdown-body");  // ìŠ¤íƒ€ì¼ ì ìš©
                  loader.inner.innerHTML = renderMarkdown(currentContent);

                  if (data.conversation_id) {
                    conversationId = data.conversation_id;
                  }
                  if (data.perfume_list && data.perfume_list.length > 0) {
                    addPerfumeRecommendations(loader.wrap, data.perfume_list);
                  }
                  loadConversations();
                  return;
                }
              } catch (e) {
                console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', e, line);
              }
            }
          }
        }

      } catch (e) {
        loader.inner.innerHTML = renderMarkdown(`ì˜¤ë¥˜: ${e && e.message ? e.message : e}`);
      } finally {
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
      }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    sendBtn.addEventListener("click", send);
    input.addEventListener("keypress", (e) => { if (e.key === "Enter") send(); });
    newBtn.addEventListener("click", startNewChat);

    // í˜„ì¬ ëŒ€í™” ID ì„¤ì •
    {% if current_conversation_id %}
      conversationId = {{ current_conversation_id }};
    {% endif %}

    // ì´ˆê¸° ë©”ì‹œì§€ ë³µì›
    try {
      if (INITIAL_MESSAGES && INITIAL_MESSAGES.length > 0) {
        box.innerHTML = '';
        INITIAL_MESSAGES.forEach((msg, idx) => {
          if (msg && typeof msg === 'object' && msg.content) {
            const el = addMessage(msg.content, msg.role === 'user');
            if (msg.role === 'assistant' && msg.perfume_list && Array.isArray(msg.perfume_list) && msg.perfume_list.length > 0) {
              addPerfumeRecommendations(el.wrap, msg.perfume_list);
            }
          }
        });
      } else {
        box.innerHTML = '';
        addMessage("ì•ˆë…•í•˜ì„¸ìš”! ScentPick AIì…ë‹ˆë‹¤. ì–´ë–¤ í–¥ìˆ˜ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?", false, false);
      }
    } catch (e) {
      console.warn('ì´ˆê¸° ë©”ì‹œì§€ ë³µì› ì˜¤ë¥˜:', e);
      addMessage("ì•ˆë…•í•˜ì„¸ìš”! ScentPick AIì…ë‹ˆë‹¤. ì–´ë–¤ í–¥ìˆ˜ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?", false, false);
    }

  })();
</script>
{% endblock %}
