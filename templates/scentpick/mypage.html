{% extends "scentpick/base.html" %}
{% block title %}마이페이지 - ScentPick{% endblock %}
{% block body_class %}mypage{% endblock %}

{% block content %}
<h2 style="margin-bottom:30px;color:#2d3748;">마이페이지</h2>

<div class="mypage-container">
  <!-- 좌측 프로필 -->
  <div class="profile-section" style="grid-row: 1 / span 2;">
    <div class="profile-avatar" style="width:80px;height:80px;border-radius:50%;overflow:hidden;border:1px solid #e2e8f0;margin-bottom:8px;display:flex;align-items:center;justify-content:center;background:#f9fafb;">
      <img src="{{ request.user.detail.avatar_url }}" alt="avatar" style="width:100%;height:100%;object-fit:cover;">
    </div>
    <div class="profile-name" style="font-size:14px;margin-bottom:15px;">{{ request.user.detail.name|default:request.user.username }}님</div>
    <ul class="profile-menu">
      <li><a href="{% url 'scentpick:profile_edit' %}" style="text-decoration:none!important;color:#4a5568!important;display:block!important;padding:4px 6px!important;border-radius:4px!important;transition:background-color 0.2s!important;text-align:center!important;white-space:nowrap!important;overflow:hidden!important;text-overflow:ellipsis!important;border:none!important;background:#fff!important;font-weight:400!important;">회원정보 수정</a></li>
      {% if request.user.has_usable_password %}
      <li><a href="{% url 'scentpick:password_change' %}" style="text-decoration:none!important;color:#4a5568!important;;display:block!important;padding:4px 6px!important;border-radius:4px!important;transition:background-color 0.2s!important;text-align:center!important;white-space:nowrap!important;overflow:hidden!important;text-overflow:ellipsis!important;border:none!important;background:#fff!important;font-weight:400!important;">비밀번호 변경</a></li>
      {% endif %}
      <li><a class="danger" href="{% url 'uauth:logout' %}" style="text-decoration:none!important;color:#e53e3e!important;display:block!important;padding:4px 6px!important;border-radius:4px!important;transition:background-color 0.2s!important;text-align:center!important;white-space:nowrap!important;overflow:hidden!important;text-overflow:ellipsis!important;border:none!important;background:#fff!important;font-weight:400!important;">로그아웃</a></li>
    </ul>
  </div>

  <!-- 가운데: 추천 내역 -->
  <div class="recommendations-section" style="grid-column: 2 / 4;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
      <h3 style="margin:0;">추천 받은 향수 내역</h3>
      <button id="toggle-rec-btn" type="button"
              style="padding:6px 10px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;cursor:pointer;font-size:12px;">
        목록 접기
      </button>
    </div>

    <div id="rec-list-wrap" class="rec-list-wrap" style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:14px 16px;">
      <div id="rec-ajax"><!-- ★ 이 내부만 AJAX로 교체 -->
      {% if rec_page and rec_page.object_list %}
        <!-- 헤더 (정렬 가능) -->
        <div class="rec-head" style="display:grid;grid-template-columns:92px 120px 1fr 64px;gap:8px;padding:6px 8px;color:#64748b;font-size:13px;">
          <div class="rec-th sort-th" data-sort-by="date"  style="cursor:pointer;user-select:none;">
            추천날짜
            <span class="sort-caret">
              {% if sort_by == 'date' %}
                {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}
              {% endif %}
            </span>
          </div>
          <div class="rec-th sort-th" data-sort-by="brand" style="cursor:pointer;user-select:none;">
            브랜드
            <span class="sort-caret">
              {% if sort_by == 'brand' %}
                {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}
              {% endif %}
            </span>
          </div>
          <div class="rec-th sort-th" data-sort-by="name"  style="cursor:pointer;user-select:none;">
            제품명
            <span class="sort-caret">
              {% if sort_by == 'name' %}
                {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}
              {% endif %}
            </span>
          </div>
          <div class="rec-th sort-th" data-sort-by="count" style="text-align:right; cursor:pointer; user-select:none;">
            추천횟수
            <span class="sort-caret">
              {% if sort_by == 'count' %}
                {% if sort_dir == 'asc' %}▲{% else %}▼{% endif %}
              {% endif %}
            </span>
          </div>
        </div>
        <div style="height:1px;background:#e5e7eb;margin:4px 0 6px;"></div>

        <!-- 항목 -->
        <ul class="rec-list" style="list-style:none;margin:0;padding:0;">
          {% for item in rec_page.object_list %}
          <li style="display:grid;grid-template-columns:92px 120px 1fr 64px;gap:8px;padding:8px 8px;border-radius:8px;align-items:center;">
            <div style="color:#475569;font-size:13px;">{{ item.last_date|date:"y.m.d" }}</div>
            <div style="color:#334155;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">{{ item.perfume__brand }}</div>
            <div style="font-weight:600;">
              <a href="/perfume/{{ item.perfume_id }}/"
                 style="color:#2563eb;text-decoration:none;white-space:normal;overflow:visible;text-overflow:clip;overflow-wrap:anywhere;display:inline-block;font-size:13px;">
                {{ item.perfume__name }}
              </a>
            </div>
            <div style="text-align:right;color:#111827;font-size:13px;">{{ item.rec_count }}</div>
          </li>
          {% endfor %}
        </ul>

        <!-- 페이지네이션 (컴팩트 고정 레이아웃) -->
        {% if rec_page.paginator.num_pages > 1 %}
        <div class="rec-pagination" style="display:flex;align-items:center;justify-content:center;gap:12px;margin-top:10px;min-height:32px;">
          <div class="pagination-prev" style="min-width:40px;text-align:center;">
            {% if rec_page.has_previous %}
              <a data-rec-pg="{{ rec_page.previous_page_number }}" href="?page={{ rec_page.previous_page_number }}" style="color:#2563eb;text-decoration:none;">이전</a>
            {% endif %}
          </div>
          
          <div class="pagination-numbers" style="display:flex;gap:4px;align-items:center;">
            {% if rec_page.paginator.num_pages <= 7 %}
              <!-- 7페이지 이하면 모두 표시 -->
              {% for p in rec_page.paginator.page_range %}
                {% if p == rec_page.number %}
                  <strong class="rec-pg" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;background:#e2e8f0;border:1px solid #cbd5e1;color:#111827;font-size:13px;">{{ p }}</strong>
                {% else %}
                  <a class="rec-pg" data-rec-pg="{{ p }}" href="?page={{ p }}" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;text-decoration:none;color:#2563eb;font-size:13px;">{{ p }}</a>
                {% endif %}
              {% endfor %}
            {% else %}
              <!-- 7페이지 초과시 축약 표시 -->
              {% if rec_page.number <= 4 %}
                <!-- 현재 페이지가 앞쪽에 있을 때 -->
                {% for p in "12345"|make_list %}
                  {% if p|add:"0" == rec_page.number %}
                    <strong class="rec-pg" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;background:#e2e8f0;border:1px solid #cbd5e1;color:#111827;font-size:13px;">{{ p }}</strong>
                  {% else %}
                    <a class="rec-pg" data-rec-pg="{{ p }}" href="?page={{ p }}" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;text-decoration:none;color:#2563eb;font-size:13px;">{{ p }}</a>
                  {% endif %}
                {% endfor %}
                <span style="color:#64748b;padding:0 4px;">...</span>
                <a class="rec-pg" data-rec-pg="{{ rec_page.paginator.num_pages }}" href="?page={{ rec_page.paginator.num_pages }}" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;text-decoration:none;color:#2563eb;font-size:13px;">{{ rec_page.paginator.num_pages }}</a>
              {% elif rec_page.number >= rec_page.paginator.num_pages|add:"-3" %}
                <!-- 현재 페이지가 뒤쪽에 있을 때 -->
                <a class="rec-pg" data-rec-pg="1" href="?page=1" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;text-decoration:none;color:#2563eb;font-size:13px;">1</a>
                <span style="color:#64748b;padding:0 4px;">...</span>
                {% for p in rec_page.paginator.num_pages|add:"-4"|stringformat:"d"|add:","|add:rec_page.paginator.num_pages|stringformat:"d"|make_list %}
                  {% if p == rec_page.number|stringformat:"s" %}
                    <strong class="rec-pg" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;background:#e2e8f0;border:1px solid #cbd5e1;color:#111827;font-size:13px;">{{ p }}</strong>
                  {% else %}
                    <a class="rec-pg" data-rec-pg="{{ p }}" href="?page={{ p }}" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;text-decoration:none;color:#2563eb;font-size:13px;">{{ p }}</a>
                  {% endif %}
                {% endfor %}
              {% else %}
                <!-- 현재 페이지가 중간에 있을 때 -->
                <a class="rec-pg" data-rec-pg="1" href="?page=1" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;text-decoration:none;color:#2563eb;font-size:13px;">1</a>
                <span style="color:#64748b;padding:0 4px;">...</span>
                <a class="rec-pg" data-rec-pg="{{ rec_page.number|add:'-1' }}" href="?page={{ rec_page.number|add:'-1' }}" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;text-decoration:none;color:#2563eb;font-size:13px;">{{ rec_page.number|add:"-1" }}</a>
                <strong class="rec-pg" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;background:#e2e8f0;border:1px solid #cbd5e1;color:#111827;font-size:13px;">{{ rec_page.number }}</strong>
                <a class="rec-pg" data-rec-pg="{{ rec_page.number|add:'1' }}" href="?page={{ rec_page.number|add:'1' }}" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;text-decoration:none;color:#2563eb;font-size:13px;">{{ rec_page.number|add:"1" }}</a>
                <span style="color:#64748b;padding:0 4px;">...</span>
                <a class="rec-pg" data-rec-pg="{{ rec_page.paginator.num_pages }}" href="?page={{ rec_page.paginator.num_pages }}" style="display:inline-flex;align-items:center;justify-content:center;min-width:28px;height:28px;padding:0 6px;border-radius:6px;text-decoration:none;color:#2563eb;font-size:13px;">{{ rec_page.paginator.num_pages }}</a>
              {% endif %}
            {% endif %}
          </div>
          
          <div class="pagination-next" style="min-width:40px;text-align:center;">
            {% if rec_page.has_next %}
              <a data-rec-pg="{{ rec_page.next_page_number }}" href="?page={{ rec_page.next_page_number }}" style="color:#2563eb;text-decoration:none;">다음</a>
            {% endif %}
          </div>
        </div>
        {% else %}
        <div style="min-height:32px;margin-top:10px;"></div>
        {% endif %}
      {% else %}
        <p style="text-align:center;color:#718096;font-style:italic;margin:10px 0;">아직 추천받은 향수가 없습니다.</p>
      {% endif %}
      </div><!-- /#rec-ajax -->
    </div>
  </div>

  <!-- 아래 좌측: 선호/비선호 -->
  <div class="recommendations-section like-dislike-section" style="grid-column: 2 / 3;">
    <div class="like-dislike-container" style="margin-top: 8px;">
      <!-- ✅ 선호 -->
      <div class="likes-section"><h3 class="section-title">선호 향수 ({{ likes_count }}개)</h3>
        <div class="recommendations-grid" style="display:grid!important;grid-template-columns:repeat(2,minmax(0,1fr))!important;gap:16px!important;margin-bottom:20px!important;margin-top:15px!important;width:100%!important;box-sizing:border-box!important;">
          {% for feedback in liked_perfumes %}
          <div class="recommendation-card like-card perfume-card-clickable" data-feedback-id="{{ feedback.id }}" data-perfume-id="{{ feedback.perfume.id }}">
            <div class="recommendation-date">{{ feedback.created_at|date:"Y.m.d" }}</div>
            <div class="perfume-image-container" style="margin:0 auto 10px;">
              <img src="https://scentpick-images.s3.ap-northeast-2.amazonaws.com/perfumes/{{ feedback.perfume.id }}.jpg" alt="{{ feedback.perfume.name }}" class="perfume-img">
            </div>
            <div class="perfume-title" title="{{ feedback.perfume.name }}">{{ feedback.perfume.name }}</div>
            <div class="perfume-brand">{{ feedback.perfume.brand }}</div>
            <div style="display:flex;justify-content:center;gap:5px;">
              <button class="feedback-btn like-btn active" data-action="like">선호</button>
              <button class="feedback-btn dislike-btn" data-action="dislike">비선호</button>
            </div>
          </div>
          {% endfor %}
        </div>
        {% if not liked_perfumes %}<p class="empty-message" style="color:#718096;font-style:italic;text-align:center;">선호 향수가 없습니다.</p>{% endif %}
      </div>

      <!-- ✅ 비선호 -->
      <div class="dislikes-section"><h3 class="section-title">비선호 향수 ({{ dislikes_count }}개)</h3>
        <div class="recommendations-grid" style="display:grid!important;grid-template-columns:repeat(2,minmax(0,1fr))!important;gap:16px!important;margin-bottom:20px!important;margin-top:15px!important;width:100%!important;box-sizing:border-box!important;">
          {% for feedback in disliked_perfumes %}
          <div class="recommendation-card dislike-card perfume-card-clickable" data-feedback-id="{{ feedback.id }}" data-perfume-id="{{ feedback.perfume.id }}">
            <div class="recommendation-date">{{ feedback.created_at|date:"Y.m.d" }}</div>
            <div class="perfume-image-container" style="margin:0 auto 10px;">
              <img src="https://scentpick-images.s3.ap-northeast-2.amazonaws.com/perfumes/{{ feedback.perfume.id }}.jpg"
                   alt="{{ feedback.perfume.name }}" class="perfume-img"
                   onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTAiIGhlaWdodD0iMTIwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI5MCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNlNTNlM2UiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIxMiIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5PPC90ZXh0Pjwvc3ZnPg=='">
            </div>
            <div class="perfume-title" title="{{ feedback.perfume.name }}">{{ feedback.perfume.name }}</div>
            <div class="perfume-brand">{{ feedback.perfume.brand }}</div>
            <div style="display:flex;justify-content:center;gap:5px;">
              <button class="feedback-btn like-btn" data-action="like">선호</button>
              <button class="feedback-btn dislike-btn active" data-action="dislike">비선호</button>
            </div>
          </div>
          {% endfor %}
        </div>
        {% if not disliked_perfumes %}<p class="empty-message" style="color:#718096 !important; font-style:italic; text-align:center; padding:40px 20px;">비선호 향수가 없습니다.</p>{% endif %}
      </div>
    </div>
  </div>

  <!-- 아래 우측: 즐겨찾기 -->
  <div class="favorites-section" style="grid-column: 3 / 4;">
    <div class="like-dislike-container" style="margin-top: 8px;">
      <!-- ✅ 즐겨찾기 -->
      <div class="favorites-main-section"><h3 class="section-title">즐겨찾기 ({{ favorites_count }}개)</h3>
        {% if favorite_perfumes %}
        <div class="recommendations-grid" style="display:grid!important;grid-template-columns:repeat(2,minmax(0,1fr))!important;gap:16px!important;margin-bottom:20px!important;margin-top:15px!important;width:100%!important;box-sizing:border-box!important;">
          {% for perfume in favorite_perfumes %}
          <div class="recommendation-card favorite-card perfume-card-clickable" data-perfume-id="{{ perfume.id }}">
            <div class="recommendation-date" style="visibility: hidden;">즐겨찾기</div>
            <div class="perfume-image-container" style="margin:0 auto 10px;">
              <img src="https://scentpick-images.s3.ap-northeast-2.amazonaws.com/perfumes/{{ perfume.id }}.jpg"
                   alt="{{ perfume.name }}" class="perfume-img"
                   onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTAiIGhlaWdodD0iMTIwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI5MCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiM0YTkwZTIiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIxMiIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkZBVjwvdGV4dD48L3N2Zz4='">
            </div>
            <div class="perfume-title" title="{{ perfume.name }}">{{ perfume.name }}</div>
            <div class="perfume-brand">{{ perfume.brand }}</div>
            <div style="display:flex;justify-content:center;">
              <button class="remove-favorite" data-perfume-id="{{ perfume.id }}" style="background:#4a90e2;color:white;border:none;padding:6px 12px;border-radius:15px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;">즐겨찾기 해제</button>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="empty-message" style="color:#718096 !important; font-style:italic; text-align:center; padding:40px 20px;">즐겨찾기한 향수가 없습니다.</p>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endblock content %}

{% block script %}
<script>
(function () {
  // --- CSRF ---
  function getCookie(name) {
    let v=null; if(document.cookie && document.cookie!==''){
      document.cookie.split(';').some(c=>{
        c=c.trim(); if(c.startsWith(name+'=')){ v=decodeURIComponent(c.slice(name.length+1)); return true;}
      });
    } return v;
  }

  function getState(card){
    if(card.classList.contains('like-card')) return 'like';
    if(card.classList.contains('dislike-card')) return 'dislike';
    return 'none';
  }

  function styleButtons(card, state){
    const likeBtn=card.querySelector('[data-action="like"]');
    const dislikeBtn=card.querySelector('[data-action="dislike"]');
    likeBtn.classList.toggle('active', state==='like');
    dislikeBtn.classList.toggle('active', state==='dislike');
    if(state==='like'){
      likeBtn.style.background='#4a90e2'; likeBtn.style.color='#fff'; likeBtn.style.border='none';
      dislikeBtn.style.background='#f7fafc'; dislikeBtn.style.color='#4a5568'; dislikeBtn.style.border='1px solid #e2e8f0';
      card.classList.add('like-card'); card.classList.remove('dislike-card');
    }else if(state==='dislike'){
      dislikeBtn.style.background='#e74c3c'; dislikeBtn.style.color='#fff'; dislikeBtn.style.border='none';
      likeBtn.style.background='#f7fafc'; likeBtn.style.color='#4a5568'; likeBtn.style.border='1px solid #e2e8f0';
      card.classList.add('dislike-card'); card.classList.remove('like-card');
    }else{
      [likeBtn,dislikeBtn].forEach(b=>{ b.classList.remove('active'); b.style.background='#f7fafc'; b.style.color='#4a5568'; b.style.border='1px solid #e2e8f0';});
      card.classList.remove('like-card','dislike-card');
    }
  }

  function moveCard(card, to){
    const grid=document.querySelector(`.${to}s-section .recommendations-grid`);
    if(grid) grid.appendChild(card);
  }

  function updateCounts(){
    const likeGrid=document.querySelector('.likes-section .recommendations-grid');
    const dislikeGrid=document.querySelector('.dislikes-section .recommendations-grid');
    const likeCnt=likeGrid ? likeGrid.querySelectorAll('.recommendation-card').length : 0;
    const dislikeCnt=dislikeGrid ? dislikeGrid.querySelectorAll('.recommendation-card').length : 0;
    const h3Like=document.querySelector('.likes-section h3');
    const h3Dislike=document.querySelector('.dislikes-section h3');
    if(h3Like){ h3Like.textContent=`선호 향수 (${likeCnt}개)`; h3Like.classList.toggle('zero-count', likeCnt===0); }
    if(h3Dislike){ h3Dislike.textContent=`비선호 향수 (${dislikeCnt}개)`; h3Dislike.classList.toggle('zero-count', dislikeCnt===0); }

    function ensureEmpty(sectionSel, grid, msg){
      const section=document.querySelector(sectionSel);
      if(!section) return;
      let empty=section.querySelector('.empty-message');
      const hasCard=grid && grid.querySelector('.recommendation-card');
      if(!hasCard){
        if(!empty){
          empty=document.createElement('p');
          empty.className='empty-message';
          empty.textContent=msg;
          empty.style.setProperty('color', '#718096', 'important');
          section.appendChild(empty);
        }
      }else if(empty){ empty.remove(); }
    }
    ensureEmpty('.likes-section', likeGrid, '선호 향수가 없습니다.');
    ensureEmpty('.dislikes-section', dislikeGrid, '비선호 향수가 없습니다.');
    if (window.updateLikeDislikeTabCounts) window.updateLikeDislikeTabCounts();
    if (window.repaginateAll) window.repaginateAll();
  }

  // ★ 높이 고정 + 5줄 패딩
  function padRecRowsAndLockHeight(){
    const wrap = document.getElementById('rec-list-wrap');
    if(!wrap) return;
    const list   = wrap.querySelector('.rec-list');
    const header = wrap.querySelector('.rec-head');
    const divider= wrap.querySelector(':scope > #rec-ajax > div + div');
    if(!list || !header || !divider) return;

    const realRow = list.querySelector('li:not(.rec-pad-row)');
    if(!realRow) return;

    const rowH = realRow.getBoundingClientRect().height;
    const ROWS = 5;

    list.querySelectorAll('.rec-pad-row').forEach(n=>n.remove());
    const now  = list.children.length;
    for(let i=now;i<ROWS;i++){
      const li = document.createElement('li');
      li.className = 'rec-pad-row';
      li.style.height = rowH + 'px';
      list.appendChild(li);
    }

    const wrapStyle = getComputedStyle(wrap);
    const padTop = parseFloat(wrapStyle.paddingTop)||0;
    const padBot = parseFloat(wrapStyle.paddingBottom)||0;
    const headH  = header.getBoundingClientRect().height;
    const divH   = divider.getBoundingClientRect().height;
    const minH   = headH + divH + (ROWS * rowH) + padTop + padBot;
    wrap.style.minHeight = Math.ceil(minH) + 'px';
  }

  // ★ 페이지네이션 AJAX (정렬 파라미터 유지)
  async function gotoRecPage(pg){
    const host = document.getElementById('rec-ajax');
    if(!host) return;

    const currentScrollY = window.scrollY;
    const currentScrollX = window.scrollX;

    const url = new URL(window.location.href);
    url.searchParams.set('page', pg);

    host.classList.add('rec-loading');
    try{
      const html = await fetch(url.toString(), {credentials:'same-origin'}).then(r=>r.text());
      const doc  = new DOMParser().parseFromString(html, 'text/html');
      const next = doc.getElementById('rec-ajax');
      if(next){
        host.innerHTML = next.innerHTML;
        padRecRowsAndLockHeight();

        window.scrollTo(currentScrollX, currentScrollY);
        requestAnimationFrame(() => {
          window.scrollTo(currentScrollX, currentScrollY);
        });
        history.replaceState(null, '', url.pathname + '?' + url.searchParams.toString());
      }
    }finally{
      host.classList.remove('rec-loading');
      window.scrollTo(currentScrollX, currentScrollY);
    }
  }

  // 정렬 토글 처리
  function toggleSort(sortBy){
    const url = new URL(window.location.href);
    const curBy  = url.searchParams.get('sort_by')  || '{{ sort_by|default:"date" }}';
    const curDir = url.searchParams.get('sort_dir') || '{{ sort_dir|default:"desc" }}';
    let nextDir  = 'desc';

    if(curBy === sortBy){
      nextDir = (curDir === 'desc') ? 'asc' : 'desc';
    }else{
      nextDir = 'desc';
    }
    url.searchParams.set('sort_by',  sortBy);
    url.searchParams.set('sort_dir', nextDir);
    url.searchParams.set('page', '1');

    const host = document.getElementById('rec-ajax');
    if(!host) { window.location.href = url.toString(); return; }

    host.classList.add('rec-loading');
    fetch(url.toString(), {credentials:'same-origin'})
      .then(r=>r.text())
      .then(html=>{
        const doc  = new DOMParser().parseFromString(html, 'text/html');
        const next = doc.getElementById('rec-ajax');
        if(next){
          host.innerHTML = next.innerHTML;
          padRecRowsAndLockHeight();
          history.replaceState(null, '', url.pathname + '?' + url.searchParams.toString());
        }else{
          window.location.href = url.toString();
        }
      })
      .catch(()=>{ window.location.href = url.toString(); })
      .finally(()=> host.classList.remove('rec-loading'));
  }

  // 이벤트 위임
  document.addEventListener('click', async (e)=>{
    // 피드백
    const btn=e.target.closest('.feedback-btn');
    if(btn){
      e.preventDefault(); e.stopPropagation();
      const card=btn.closest('.recommendation-card');
      const feedbackId=card?.dataset.feedbackId;
      const action=btn.dataset.action;
      const current=getState(card);
      if(!feedbackId) return;

      try{
        if(current===action){
          if(!confirm('피드백을 취소하시겠습니까?')) return;
          const r=await fetch('/scentpick/api/delete-feedback/',{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
            body:JSON.stringify({feedback_id:parseInt(feedbackId)})
          });
          if(!r.ok) throw new Error();
          const j=await r.json(); if(j.status!=='success') throw new Error();
          card.remove();
          if (window.repaginateAll) window.repaginateAll();
        }else{
          const r=await fetch('/scentpick/api/update-feedback/',{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
            body:JSON.stringify({feedback_id:parseInt(feedbackId), action})
          });
          if(!r.ok) throw new Error();
          const j=await r.json(); if(j.status!=='success') throw new Error();
          moveCard(card, action);
          styleButtons(card, action);
        }
        updateCounts();
      }catch(err){ console.error(err); alert('요청 처리 중 오류가 발생했습니다.'); }
      return;
    }

    // 페이지네이션 (화면 이동 방지)
    const pa = e.target.closest('a[data-rec-pg]');
    if(pa){
      e.preventDefault();
      e.stopPropagation();
      const pg = pa.getAttribute('data-rec-pg') || '1';
      gotoRecPage(pg);
      return;
    }

    // 정렬 헤더 클릭
    const th = e.target.closest('.sort-th');
    if(th){
      e.preventDefault(); e.stopPropagation();
      const by = th.getAttribute('data-sort-by');
      if(by){ toggleSort(by); }
      return;
    }

    // 즐겨찾기 해제
    const fav=e.target.closest('.remove-favorite');
    if(fav){
      e.preventDefault(); e.stopPropagation();
      const card=fav.closest('.recommendation-card');
      const perfumeId=parseInt(fav.dataset.perfumeId);
      try{
        const r=await fetch('/scentpick/api/toggle-favorite/',{
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
          body:JSON.stringify({perfume_id:perfumeId})
        });
        const j=await r.json();
        if(j.status==='success'){ 
          card.remove();
          if (window.repaginateAll) window.repaginateAll(); 
          const h3=document.querySelector('.favorites-section h3');
          if(h3){ const m=h3.textContent.match(/\d+/); const n=m?Math.max(parseInt(m[0])-1,0):0; h3.textContent=`즐겨찾기 (${n}개)`; }
        }
      }catch(err){ console.error(err); alert('즐겨찾기 해제 중 오류가 발생했습니다.'); }
      return;
    }

    // 카드 이동
    const card=e.target.closest('.perfume-card-clickable');
    if(card && !e.target.closest('.feedback-btn') && !e.target.closest('.remove-favorite')){
      const id=card.dataset.perfumeId;
      if(id) window.location.href=`/perfume/${id}/`;
    }
  });

  // 초기화
  document.addEventListener('DOMContentLoaded', ()=>{
    document.querySelectorAll('.likes-section .recommendation-card').forEach(c=>styleButtons(c,'like'));
    document.querySelectorAll('.dislikes-section .recommendation-card').forEach(c=>styleButtons(c,'dislike'));
    padRecRowsAndLockHeight();
    updateCounts();
  });
})();

document.addEventListener("DOMContentLoaded", function(){
  const btn  = document.getElementById("toggle-rec-btn");
  const wrap = document.getElementById("rec-list-wrap");
  if (!btn || !wrap) return;
  btn.addEventListener("click", function(){
    const hidden = wrap.style.display === "none";
    wrap.style.display = hidden ? "block" : "none";
    btn.textContent   = hidden ? "목록 접기" : "목록 펼치기";
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const wrap = document.querySelector('.like-dislike-section .like-dislike-container');
  if (!wrap) return;
  const likes = wrap.querySelector('.likes-section');
  const dislikes = wrap.querySelector('.dislikes-section');
  if (!likes || !dislikes) return;

  // 탭 바 생성
  const likeCnt = likes.querySelectorAll('.recommendation-card').length;
  const dislikeCnt = dislikes.querySelectorAll('.recommendation-card').length;

  const bar = document.createElement('div');
  bar.className = 'ld-tabs';
  bar.innerHTML = `
    <button class="ld-tab on" data-tab="likes">선호 (${likeCnt}개)</button>
    <button class="ld-tab" data-tab="dislikes">비선호 (${dislikeCnt}개)</button>
  `;
  wrap.insertBefore(bar, likes);

  // 기본은 선호만 표시
  dislikes.style.display = 'none';

  // 탭 토글
  bar.addEventListener('click', (e) => {
    const btn = e.target.closest('.ld-tab'); if (!btn) return;
    bar.querySelectorAll('.ld-tab').forEach(b => b.classList.remove('on'));
    btn.classList.add('on');
    const tab = btn.dataset.tab;
    likes.style.display    = (tab === 'likes')    ? '' : 'none';
    dislikes.style.display = (tab === 'dislikes') ? '' : 'none';
  });

  // 개수 갱신 훅 (updateCounts()에서 호출)
  window.updateLikeDislikeTabCounts = function () {
    const likeCnt = likes.querySelectorAll('.recommendation-card').length;
    const dislikeCnt = dislikes.querySelectorAll('.recommendation-card').length;
    const likeBtn = bar.querySelector('[data-tab="likes"]');
    const dislikeBtn = bar.querySelector('[data-tab="dislikes"]');
    if (likeBtn) likeBtn.textContent = `선호 (${likeCnt}개)`;
    if (dislikeBtn) dislikeBtn.textContent = `비선호 (${dislikeCnt}개)`;
  };
});
</script>

<script>
/* ====== 그리드 페이지네이션 (공용) ====== */
(function(){
  const PAGE_SIZE = 6;

  // ★ 비어있는 칸을 채우는 투명 패드 추가
  function fillPlaceholders(grid){
    if (!grid) return;
    // 기존 패드 제거
    grid.querySelectorAll('.grid-pad').forEach(n=>n.remove());

    // 보이는 카드 개수
    const cards = Array.from(grid.querySelectorAll('.recommendation-card'))
      .filter(c => c.style.display !== 'none');
    const visible = cards.length;

    if (visible === 0) return;

    // 보이는 개수에 따라 pageSize 조정
    let pageSize;
    if (visible <= 2) pageSize = 2;
    else if (visible <= 4) pageSize = 4;
    else pageSize = PAGE_SIZE; // 6

    const need = Math.max(pageSize - visible, 0);
    if (!need) return;

    // 카드 높이 측정 (숨겨진 카드만 있다면 임시 표시해서 측정)
    let sample = cards[0] || grid.querySelector('.recommendation-card');
    let h = 300;
    if (sample){
      const wasHidden = sample.style.display === 'none';
      if (wasHidden) sample.style.display = 'flex';
      h = sample.getBoundingClientRect().height || h;
      if (wasHidden) sample.style.display = 'none';
    }

    // 필요 개수만큼 패드 생성
    for (let i=0;i<need;i++){
      const pad = document.createElement('div');
      pad.className = 'grid-pad';
      pad.style.height = h + 'px';
      grid.appendChild(pad);
    }
  }


  function applyPagination(grid, pageSize = PAGE_SIZE){
    if (!grid) return;
    const cards = Array.from(grid.querySelectorAll('.recommendation-card'));
    const total = cards.length;
    const pages = Math.max(Math.ceil(total / pageSize), 1);

    let page = parseInt(grid.dataset.page || '1', 10);
    if (page < 1) page = 1;
    if (page > pages) page = pages;
    grid.dataset.page = String(page);

    // 이 페이지 구간만 정확히 노출
      cards.forEach(c => c.style.display = 'none');
      const start = (page - 1) * pageSize;
      cards.slice(start, start + pageSize).forEach(c => c.style.display = 'flex');


    // ★ 부족한 칸은 투명 패드로 채우기
    fillPlaceholders(grid, pageSize);

    // 페이지 바 만들기/갱신
    let pager = grid.nextElementSibling;
    if (!pager || !pager.classList.contains('grid-pager')) {
      pager = document.createElement('div');
      pager.className = 'grid-pager';
      grid.after(pager);
    }

    if (pages === 1) {
      pager.innerHTML = '';
      pager.style.display = 'flex';
      pager.classList.add('grid-pager--empty');
      return;
    } else {
      pager.classList.remove('grid-pager--empty');
    }
    pager.style.display = 'flex';

    const btn = (n, active=false) => `<button class="gp-num ${active?'on':''}" data-p="${n}">${n}</button>`;
    let html = `<button class="gp-prev"${page===1?' disabled':''}>&lt;</button><div class="gp-pages">`;

    if (pages <= 5) {
      for (let n=1;n<=pages;n++) html += btn(n, n===page);
    } else {
      const pushRange=(s,e)=>{ for(let n=s;n<=e;n++) html+=btn(n, n===page); };
      if (page <= 3) { pushRange(1,3); html += `<span class="gp-ellipsis">…</span>`; html += btn(pages); }
      else if (page >= pages-2) { html += btn(1); html += `<span class="gp-ellipsis">…</span>`; pushRange(pages-2,pages); }
      else { html += btn(1); html += `<span class="gp-ellipsis">…</span>`; pushRange(page-1,page+1); html += `<span class="gp-ellipsis">…</span>`; html += btn(pages); }
    }

    html += `</div><button class="gp-next"${page===pages?' disabled':''}>&gt;</button>`;
    pager.innerHTML = html;

    pager.onclick = (e)=>{
      const num = e.target.closest('.gp-num');
      if (num) { grid.dataset.page = num.dataset.p; applyPagination(grid, pageSize); return; }
      if (e.target.closest('.gp-prev') && page > 1) { grid.dataset.page = page-1; applyPagination(grid, pageSize); return; }
      if (e.target.closest('.gp-next') && page < pages) { grid.dataset.page = page+1; applyPagination(grid, pageSize); return; }
    };
  }

  function repaginateAll(){
    applyPagination(document.querySelector('.likes-section .recommendations-grid'));
    applyPagination(document.querySelector('.dislikes-section .recommendations-grid'));
    applyPagination(document.querySelector('.favorites-section .recommendations-grid'));
  }

  window.repaginateAll = repaginateAll;

  document.addEventListener('DOMContentLoaded', repaginateAll);

  document.addEventListener('click', (e)=>{
    const tab = e.target.closest('.ld-tab');
    if (tab) repaginateAll();
  });
})();
</script>
<script>
  // 뒤로가기 했을 때 캐시 화면이 뜨지 않게 강제로 새로고침
  window.addEventListener("pageshow", function(event) {
    if (event.persisted) {
      window.location.reload();
    }
  });
</script>

{% endblock script %}

<style>
/* 패딩용 더미 행(높이는 JS에서 부여) */
.rec-list .rec-pad-row{ display:block; padding:0; border:0; visibility:hidden; pointer-events:none; }

/* 헤더 정렬 스타일 */
.rec-head .sort-th { position: relative; }
.rec-head .sort-th .sort-caret { margin-left:4px; color:#64748b; font-size:11px; }

/* 페이지네이션 컴팩트 고정 레이아웃 */
.rec-pagination{ 
  display: flex !important;
  align-items: center;
  justify-content: center;
  gap: 12px;
  margin-top: 10px;
  min-height: 32px;
}
.pagination-prev, .pagination-next { min-width: 40px; text-align: center; }
.pagination-numbers { display: flex !important; gap: 4px !important; align-items: center; justify-content: center; }
.rec-pagination a, .rec-pagination strong{
  display: inline-flex; align-items: center; justify-content: center;
  min-width: 28px; height: 28px; padding: 0 6px; border-radius: 6px; 
  text-decoration: none; color: #2563eb; font-size: 13px;
}
.rec-pagination a:hover{ background: #f1f5f9; }
.rec-pagination strong{ background: #e2e8f0; border: 1px solid #cbd5e1; color: #111827; }
.rec-pagination a:focus{ outline: none; }
.rec-pagination a { scroll-behavior: auto !important; }

/* 로딩 중 살짝 dim */
#rec-ajax.rec-loading{ opacity:.75; }

/* 마이페이지 전용 그리드 레이아웃 오버라이드 */
body.mypage .mypage-container {
  display: grid !important;
  grid-template-columns: 200px 1fr 1fr !important;
  gap: 20px !important;
  max-width: 1200px !important;
  margin: 0 auto !important;
  align-items: start !important;
}

/* 좌우 대칭을 위한 섹션 높이 맞춤 */
body.mypage .like-dislike-section,
body.mypage .favorites-section {
  min-height: 600px !important;
  display: flex !important;
  flex-direction: column !important;
}

body.mypage .like-dislike-container,
body.mypage .favorites-main-section {
  flex: 1 !important;
  display: flex !important;
  flex-direction: column !important;
}

/* 선호향수와 즐겨찾기 제목 완전 통일 */
body.mypage .likes-section h3,
body.mypage .dislikes-section h3,
body.mypage .favorites-main-section h3 {
  font-size: 18px !important;
  margin-bottom: 20px !important;
  color: #2d3748 !important;
  font-weight: 600 !important;
}

/* 그리드 간격 완전 통일 */
body.mypage .likes-section .recommendations-grid,
body.mypage .dislikes-section .recommendations-grid,
body.mypage .favorites-main-section .recommendations-grid {
  display: grid !important;
  grid-template-columns: repeat(2, 1fr) !important;
  gap: 16px !important;
  margin-top: 15px !important;
  margin-bottom: 20px !important;
}

/* 좌우 대칭을 위한 카드 높이 및 텍스트 처리 */
body.mypage .recommendation-card {
  background: #fff;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  transition: all 0.3s ease;
  height: 300px !important; /* 고정 높이 증가 */
  display: flex !important;
  flex-direction: column !important;
  justify-content: space-between !important;
  box-sizing: border-box !important;
}

body.mypage .recommendation-card:hover {
  transform: translateY(-3px) !important;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

body.mypage .recommendation-date {
  font-size: 12px;
  color: #718096;
  margin-bottom: 10px;
  height: 18px !important;
}

body.mypage .perfume-img {
  width: 60px;
  height: 80px;
  object-fit: cover;
  border-radius: 4px;
}

body.mypage .perfume-title {
  font-size: 14px;
  font-weight: 600;
  color: #2d3748;
  margin: 8px 0 4px;
  line-height: 1.3;
  height: 50px !important; /* 높이 증가 */
  overflow: hidden !important;
  display: -webkit-box !important;
  -webkit-line-clamp: 3 !important; /* 3줄로 증가 */
  -webkit-box-orient: vertical !important;
  text-overflow: ellipsis !important;
  cursor: help;
}

body.mypage .perfume-brand {
  font-size: 12px;
  color: #718096;
  margin-bottom: 12px;
  height: 16px !important;
  overflow: hidden !important;
  white-space: nowrap !important;
  text-overflow: ellipsis !important;
}

/* 즐겨찾기 카드 스타일 복원 */
body.mypage .favorites-section .recommendation-card {
  border: 2px solid #ffd700 !important;
}

body.mypage .favorites-section .recommendation-card:hover {
  box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3) !important;
}

/* 즐겨찾기 해제 버튼 원복 */
body.mypage .remove-favorite {
  background: #4a90e2 !important;
  color: white !important;
  border: none !important;
  padding: 6px 12px !important;
  border-radius: 15px !important;
  font-size: 12px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all 0.2s !important;
}

body.mypage .remove-favorite:hover {
  background: #357abd !important;
  transform: scale(1.05) !important;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
}

body.mypage .like-dislike-container { margin-top:30px; }
body.mypage .likes-section, body.mypage .dislikes-section { margin-bottom:30px; }
body.mypage .likes-section h3, body.mypage .dislikes-section h3 { font-size:18px; margin-bottom:15px; color:#2d3748; }

body.mypage .recommendations-section .rec-list-wrap .rec-list li:hover { background:#f8fafc; }
body.mypage .empty-message { text-align:center; color:#718096; font-style:italic; padding:20px 10px; }

body.mypage .likes-section .recommendations-grid,
body.mypage .dislikes-section .recommendations-grid{
  display:grid !important; grid-template-columns:repeat(2, minmax(0,1fr)) !important; gap:16px !important;
}
body.mypage .recommendation-card .feedback-btn{
  display:inline-flex !important; align-items:center !important; justify-content:center !important;
  min-width:56px !important; height:32px !important; padding:0 12px !important; border-radius:16px !important;
  border:1px solid #e2e8f0 !important; background:#f7fafc !important; color:#4a5568 !important;
  font-weight:600 !important; font-size:13px !important; cursor:pointer !important;
}
body.mypage .recommendation-card .like-btn.active{ background:#4a90e2 !important; color:#fff !important; border:none !important; }
body.mypage .recommendation-card .dislike-btn.active{ background:#e74c3c !important; color:#fff !important; border:none !important; }

/* 추천내역 그리드 강제 고정 (헤더/행 모두) */
body.mypage .recommendations-section .rec-head,
body.mypage .recommendations-section .rec-list > li{
  grid-template-columns: 92px 120px 1fr 64px !important; /* 날짜 | 브랜드 | 제품명 | 추천횟수 */
  gap: 8px !important;
}

/* 추천횟수는 오른쪽 정렬 유지 */
body.mypage .recommendations-section .rec-head > .rec-th[data-sort-by="count"],
body.mypage .recommendations-section .rec-list > li > :last-child{
  text-align: right !important;
}

/* === 추천내역 컬럼 고정(최우선 강제) === */
body.mypage #rec-list-wrap .rec-head,
body.mypage #rec-list-wrap .rec-list > li{
  grid-template-columns: 92px 120px 1fr 64px !important;
  gap: 8px !important;
}

/* 추천횟수 오른쪽 정렬 고정 */
body.mypage #rec-list-wrap .rec-head > .rec-th[data-sort-by="count"],
body.mypage #rec-list-wrap .rec-list > li > :last-child{
  text-align: right !important;
  justify-self: end !important;
}

/* 브랜드/제품명 잘림 안전장치 */
body.mypage #rec-list-wrap .rec-list > li > :nth-child(2){
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  min-width: 0 !important;
}
body.mypage #rec-list-wrap .rec-list > li > :nth-child(3) a{
  white-space: normal !important;
  overflow: visible !important;
  text-overflow: clip !important;
  word-break: break-word !important;
}

.section-title {
  margin: 0 0 20px 0 !important;
  font-size: 18px;
  color: #2d3748;
  min-height: 28px;
  display: flex;
  align-items: center;
}

</style>