{% extends "scentpick/base.html" %}
{% block title %}마이페이지 - ScentPick{% endblock %}
{% block body_class %}mypage{% endblock %}

{% block content %}
<!-- 공통 스타일 변수 -->

<h2 style="margin-bottom:30px;color:#2d3748;">마이페이지</h2>

<div class="mypage-container">
  <!-- 좌측: 프로필 -->
  
  <div class="profile-section" style="grid-row: 1 / span 2;">
    <div class="profile-avatar" style="width:80px;height:80px;border-radius:50%;overflow:hidden;border:1px solid #e2e8f0;margin-bottom:8px;display:flex;align-items:center;justify-content:center;background:#f9fafb;">
      <img src="{{ request.user.detail.avatar_url }}" alt="avatar" style="width:100%;height:100%;object-fit:cover;">
    </div>
    <div class="profile-name" style="font-size:14px;margin-bottom:15px;">{{ request.user.detail.name|default:request.user.username }}님</div>
    <ul class="profile-menu">
      <li><a href="{% url 'scentpick:profile_edit' %}" style="text-decoration:none!important;color:#4a5568!important;display:block!important;padding:4px 6px!important;border-radius:4px!important;transition:background-color 0.2s!important;text-align:center!important;white-space:nowrap!important;overflow:hidden!important;text-overflow:ellipsis!important;border:none!important;background:#fff!important;font-weight:400!important;">회원정보 수정</a></li>
      {% if request.user.has_usable_password %}
        <li><a href="{% url 'scentpick:password_change' %}" style="text-decoration:none!important;color:#4a5568!important;;display:block!important;padding:4px 6px!important;border-radius:4px!important;transition:background-color 0.2s!important;text-align:center!important;white-space:nowrap!important;overflow:hidden!important;text-overflow:ellipsis!important;border:none!important;background:#fff!important;font-weight:400!important;">비밀번호 변경</a></li>
      {% endif %}
      <li><a class="danger" href="{% url 'uauth:logout' %}" style="text-decoration:none!important;color:#e53e3e!important;display:block!important;padding:4px 6px!important;border-radius:4px!important;transition:background-color 0.2s!important;text-align:center!important;white-space:nowrap!important;overflow:hidden!important;text-overflow:ellipsis!important;border:none!important;background:#fff!important;font-weight:400!important;">로그아웃</a></li>
    </ul>
  </div>

<!-- 가운데: 추천 내역 (상단 전체 폭) -->
<div class="recommendations-section" style="grid-column: 2 / 4;">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
    <h3 style="margin:0;">추천 받은 향수 내역</h3>
    <button id="toggle-rec-btn" type="button"
            style="padding:6px 10px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;cursor:pointer;font-size:12px;">
      목록 접기
    </button>
  </div>

  <div id="rec-list-wrap" class="rec-list-wrap" style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:14px 16px;">
    {% if rec_page and rec_page.object_list %}
      <!-- 헤더 -->
      <div style="display:grid;grid-template-columns:92px 120px 1fr 54px;gap:8px;padding:6px 8px;color:#64748b;font-size:13px;">
        <div>추천날짜</div>
        <div>브랜드</div>
        <div>제품명</div>
        <div style="text-align:right;">추천횟수</div>
      </div>
      <div style="height:1px;background:#e5e7eb;margin:4px 0 6px;"></div>

      <!-- 항목 -->
      <ul class="rec-list" style="list-style:none;margin:0;padding:0;">
        {% for item in rec_page.object_list %}
          <li style="display:grid;grid-template-columns:92px 120px 1fr 54px;gap:8px;padding:8px 8px;border-radius:8px;align-items:center;">
            <div style="color:#475569;font-size:13px;">{{ item.last_date|date:"y.m.d" }}</div>
            <div style="color:#334155;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              {{ item.perfume__brand }}
            </div>
            <div style="font-weight:600;">
              <a href="/perfume/{{ item.perfume_id }}/"
                 style="color:#2563eb;text-decoration:none;white-space:normal;overflow:visible;text-overflow:clip;overflow-wrap:anywhere;display:inline-block;font-size:13px;">
                {{ item.perfume__name }}
              </a>
            </div>
            <div style="text-align:right;color:#111827;font-size:13px;">
              {{ item.rec_count }}
            </div>
          </li>
        {% endfor %}
      </ul>

      <!-- 페이지네이션: 중앙 정렬 -->
      {% if rec_page.paginator.num_pages > 1 %}
        <div class="rec-pagination"
             style="display:flex;gap:10px;align-items:center;justify-content:center;margin-top:10px;">
          {% if rec_page.has_previous %}
            <a href="?page={{ rec_page.previous_page_number }}" style="color:#2563eb;text-decoration:none;">이전</a>
          {% endif %}
          {% for p in rec_page.paginator.page_range %}
            {% if p == rec_page.number %}
              <strong style="color:#111827;">{{ p }}</strong>
            {% else %}
              <a href="?page={{ p }}" style="color:#2563eb;text-decoration:none;">{{ p }}</a>
            {% endif %}
          {% endfor %}
          {% if rec_page.has_next %}
            <a href="?page={{ rec_page.next_page_number }}" style="color:#2563eb;text-decoration:none;">다음›</a>
          {% endif %}
        </div>
      {% endif %}
    {% else %}
      <p style="text-align:center;color:#718096;font-style:italic;margin:10px 0;">
        아직 추천받은 향수가 없습니다.
      </p>
    {% endif %}
  </div>
</div>  <!-- /recommendations-section -->

<!-- 아래 좌측: 선호/비선호 -->
<!-- 아래 좌측: 선호/비선호 -->
<div class="recommendations-section like-dislike-section" style="grid-column: 2 / 3;">

  <div class="like-dislike-container" style="margin-top: 8px;">
    <!-- ✅ 선호 -->
    <div class="likes-section">
      <h3>선호 향수 ({{ likes_count }}개)</h3>
      <div class="recommendations-grid">
        {% for feedback in liked_perfumes %}
          <div class="recommendation-card like-card perfume-card-clickable"
               data-feedback-id="{{ feedback.id }}" data-perfume-id="{{ feedback.perfume.id }}">
            <div class="recommendation-date">{{ feedback.created_at|date:"Y.m.d" }}</div>
            <div class="perfume-image-container" style="margin:0 auto 10px;">
              <img src="https://scentpick-images.s3.ap-northeast-2.amazonaws.com/perfumes/{{ feedback.perfume.id }}.jpg"
                   alt="{{ feedback.perfume.name }}" class="perfume-img">
            </div>
            <div class="perfume-title">{{ feedback.perfume.name }}</div>
            <div class="perfume-brand">{{ feedback.perfume.brand }}</div>
            <div style="display:flex;justify-content:center;gap:5px;">
              <button class="feedback-btn like-btn active" data-action="like">선호</button>
              <button class="feedback-btn dislike-btn" data-action="dislike">비선호</button>
            </div>
          </div>
        {% endfor %}
      </div>
      {% if not liked_perfumes %}
        <p class="empty-message" style="color:#718096;font-style:italic;text-align:center;">선호 향수가 없습니다.</p>
      {% endif %}
    </div>

    <!-- ✅ 비선호 -->
    <div class="dislikes-section">
      <h3>비선호 향수 ({{ dislikes_count }}개)</h3>
      <div class="recommendations-grid" style="display:grid!important;grid-template-columns:repeat(2,minmax(0,1fr))!important;gap:8px!important;margin-bottom:20px!important;margin-top:15px!important;width:100%!important;box-sizing:border-box!important;">
        {% for feedback in disliked_perfumes %}
          <div class="recommendation-card dislike-card perfume-card-clickable"
               data-feedback-id="{{ feedback.id }}" data-perfume-id="{{ feedback.perfume.id }}">
            <div class="recommendation-date">{{ feedback.created_at|date:"Y.m.d" }}</div>
            <div class="perfume-image-container" style="margin:0 auto 10px;">
              <img src="https://scentpick-images.s3.ap-northeast-2.amazonaws.com/perfumes/{{ feedback.perfume.id }}.jpg"
                   alt="{{ feedback.perfume.name }}" class="perfume-img"
                   onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTAiIGhlaWdodD0iMTIwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI5MCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNlNTNlM2UiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIxMiIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5PPC90ZXh0Pjwvc3ZnPg=='">
            </div>
            <div class="perfume-title">{{ feedback.perfume.name }}</div>
            <div class="perfume-brand">{{ feedback.perfume.brand }}</div>
            <div style="display:flex;justify-content:center;gap:5px;">
              <button class="feedback-btn like-btn" data-action="like"
                      style="background:#f7fafc;border:1px solid #e2e8f0;color:#4a5568;padding:6px 12px;border-radius:15px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;">선호</button>
              <button class="feedback-btn dislike-btn active" data-action="dislike"
                      style="background:#e74c3c;color:white;border:none;padding:6px 12px;border-radius:15px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;">비선호</button>
            </div>
          </div>
        {% endfor %}
      </div>
      {% if not disliked_perfumes %}
        <p class="empty-message" style="color:#718096 !important; font-style:italic; text-align:center; padding:40px 20px;">
          비선호 향수가 없습니다.
        </p>
      {% endif %}
    </div>
  </div>
</div>

<!-- 아래 우측: 즐겨찾기 -->
<div class="favorites-section" style="grid-column: 3 / 4;">
  <h3 style="margin-bottom:20px;">⭐ 즐겨찾기 ({{ favorites_count }}개)</h3>
  {% if favorite_perfumes %}
    <div class="recommendations-grid" style="display:grid!important;grid-template-columns:repeat(2,minmax(0,1fr))!important;gap:8px!important;margin-bottom:20px!important;margin-top:15px!important;width:100%!important;box-sizing:border-box!important;">
      {% for perfume in favorite_perfumes %}
        <div class="recommendation-card favorite-card perfume-card-clickable" data-perfume-id="{{ perfume.id }}">
          <div class="recommendation-date" style="visibility: hidden;">즐겨찾기</div>
          <div class="perfume-image-container" style="margin:0 auto 10px;">
            <img src="https://scentpick-images.s3.ap-northeast-2.amazonaws.com/perfumes/{{ perfume.id }}.jpg"
                 alt="{{ perfume.name }}" class="perfume-img"
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iOTAiIGhlaWdodD0iMTIwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSI5MCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiM0YTkwZTIiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1zaXplPSIxMiIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkZBVjwvdGV4dD48L3N2Zz4='">
          </div>
          <div class="perfume-title">{{ perfume.name }}</div>
          <div class="perfume-brand">{{ perfume.brand }}</div>
          <div style="display:flex;justify-content:center;">
            <button class="remove-favorite" data-perfume-id="{{ perfume.id }}"
                    style="background:#4a90e2;color:white;border:none;padding:6px 12px;border-radius:15px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;">
              즐겨찾기 해제
            </button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p style="text-align: center; color: #718096; font-style: italic;">즐겨찾기한 향수가 없습니다.</p>
  {% endif %}
</div>



{% endblock content %}

{% block script %}
<script>
(function () {
  // --- CSRF ---
  function getCookie(name) {
    let v=null; if(document.cookie && document.cookie!==''){
      document.cookie.split(';').some(c=>{
        c=c.trim(); if(c.startsWith(name+'=')){ v=decodeURIComponent(c.slice(name.length+1)); return true;}
      });
    } return v;
  }

  // 현재 카드 상태
  function getState(card){
    if(card.classList.contains('like-card')) return 'like';
    if(card.classList.contains('dislike-card')) return 'dislike';
    return 'none';
  }

  // 버튼/카드 스타일 동기화
  function styleButtons(card, state){
    const likeBtn=card.querySelector('[data-action="like"]');
    const dislikeBtn=card.querySelector('[data-action="dislike"]');

    likeBtn.classList.toggle('active', state==='like');
    dislikeBtn.classList.toggle('active', state==='dislike');

    if(state==='like'){
      likeBtn.style.background='#4a90e2'; likeBtn.style.color='#fff'; likeBtn.style.border='none';
      dislikeBtn.style.background='#f7fafc'; dislikeBtn.style.color='#4a5568'; dislikeBtn.style.border='1px solid #e2e8f0';
      card.classList.add('like-card'); card.classList.remove('dislike-card');
    }else if(state==='dislike'){
      dislikeBtn.style.background='#e74c3c'; dislikeBtn.style.color='#fff'; dislikeBtn.style.border='none';
      likeBtn.style.background='#f7fafc'; likeBtn.style.color='#4a5568'; likeBtn.style.border='1px solid #e2e8f0';
      card.classList.add('dislike-card'); card.classList.remove('like-card');
    }else{
      [likeBtn,dislikeBtn].forEach(b=>{ b.classList.remove('active'); b.style.background='#f7fafc'; b.style.color='#4a5568'; b.style.border='1px solid #e2e8f0';});
      card.classList.remove('like-card','dislike-card');
    }
  }

  // 카드 이동
  function moveCard(card, to /* like|dislike */){
    const grid=document.querySelector(`.${to}s-section .recommendations-grid`);
    if(grid) grid.appendChild(card);
  }

  // 카운트/빈 메시지
  function updateCounts(){
    const likeGrid=document.querySelector('.likes-section .recommendations-grid');
    const dislikeGrid=document.querySelector('.dislikes-section .recommendations-grid');
    const likeCnt=likeGrid ? likeGrid.querySelectorAll('.recommendation-card').length : 0;
    const dislikeCnt=dislikeGrid ? dislikeGrid.querySelectorAll('.recommendation-card').length : 0;

    const h3Like=document.querySelector('.likes-section h3');
    const h3Dislike=document.querySelector('.dislikes-section h3');
    if(h3Like){ h3Like.textContent=`선호 향수 (${likeCnt}개)`; h3Like.classList.toggle('zero-count', likeCnt===0); }
    if(h3Dislike){ h3Dislike.textContent=`비선호 향수 (${dislikeCnt}개)`; h3Dislike.classList.toggle('zero-count', dislikeCnt===0); }

    function ensureEmpty(sectionSel, grid, msg){
      const section=document.querySelector(sectionSel);
      if(!section) return;
      let empty=section.querySelector('.empty-message');
      const hasCard=grid && grid.querySelector('.recommendation-card');

      if(!hasCard){
        if(!empty){
          empty=document.createElement('p');
          empty.className='empty-message';
          empty.textContent=msg;
          empty.style.setProperty('color', '#718096', 'important'); // yyh 회색
          section.appendChild(empty);
        }
      }else if(empty){ empty.remove(); }
    }
    ensureEmpty('.likes-section', likeGrid, '선호 향수가 없습니다.');
    ensureEmpty('.dislikes-section', dislikeGrid, '비선호 향수가 없습니다.');
  }

  // API
  async function apiUpdate(feedbackId, action){
    const r=await fetch('/scentpick/api/update-feedback/',{
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
      body:JSON.stringify({feedback_id:parseInt(feedbackId), action})
    });
    if(!r.ok) throw new Error('update failed');
    const j=await r.json(); if(j.status!=='success') throw new Error('update error');
    return j;
  }
  async function apiDelete(feedbackId){
    const r=await fetch('/scentpick/api/delete-feedback/',{
      method:'POST',
      headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
      body:JSON.stringify({feedback_id:parseInt(feedbackId)})
    });
    if(!r.ok) throw new Error('delete failed');
    const j=await r.json(); if(j.status!=='success') throw new Error('delete error');
    return j;
  }

  // 이벤트 위임
  document.addEventListener('click', async (e)=>{
    // 피드백 버튼
    const btn=e.target.closest('.feedback-btn');
    if(btn){
      e.preventDefault(); e.stopPropagation();
      const card=btn.closest('.recommendation-card');
      const feedbackId=card?.dataset.feedbackId;
      const action=btn.dataset.action;              // like | dislike
      const current=getState(card);                  // none | like | dislike
      if(!feedbackId) return;

      try{
        if(current===action){
          // 같은 버튼 → 취소(삭제)
          if(!confirm('피드백을 취소하시겠습니까?')) return;
          await apiDelete(feedbackId);
          card.remove();
        }else{
          // 반대 버튼 → 변경
          await apiUpdate(feedbackId, action);
          moveCard(card, action);
          styleButtons(card, action);
        }
        updateCounts();
      }catch(err){
        console.error(err); alert('요청 처리 중 오류가 발생했습니다.');
      }
      return;
    }

    // 즐겨찾기 해제
    const fav=e.target.closest('.remove-favorite');
    if(fav){
      e.preventDefault(); e.stopPropagation();
      const card=fav.closest('.recommendation-card');
      const perfumeId=parseInt(fav.dataset.perfumeId);
      try{
        const r=await fetch('/scentpick/api/toggle-favorite/',{
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':getCookie('csrftoken')},
          body:JSON.stringify({perfume_id:perfumeId})
        });
        const j=await r.json();
        if(j.status==='success'){ card.remove();
          const h3=document.querySelector('.favorites-section h3');
          if(h3){ const m=h3.textContent.match(/\d+/); const n=m?Math.max(parseInt(m[0])-1,0):0; h3.textContent=`⭐ 즐겨찾기 (${n}개)`; }
        }
      }catch(err){ console.error(err); alert('즐겨찾기 해제 중 오류가 발생했습니다.'); }
      return;
    }

    // 카드 클릭(버튼 클릭은 제외)
    const card=e.target.closest('.perfume-card-clickable');
    if(card && !e.target.closest('.feedback-btn') && !e.target.closest('.remove-favorite')){
      const id=card.dataset.perfumeId;
      if(id) window.location.href=`/perfume/${id}/`;
    }
  });

  // 초기화
  document.addEventListener('DOMContentLoaded', ()=>{
    // 서버에서 렌더된 초기 상태에 맞춰 버튼 스타일 정렬
    document.querySelectorAll('.likes-section .recommendation-card').forEach(c=>styleButtons(c,'like'));
    document.querySelectorAll('.dislikes-section .recommendation-card').forEach(c=>styleButtons(c,'dislike'));
    updateCounts();
  });
})();

document.addEventListener("DOMContentLoaded", function(){
    const btn  = document.getElementById("toggle-rec-btn");
    const wrap = document.getElementById("rec-list-wrap");
    if (!btn || !wrap) return;

    btn.addEventListener("click", function(){
      const hidden = wrap.style.display === "none";
      wrap.style.display = hidden ? "block" : "none";
      btn.textContent   = hidden ? "목록 접기" : "목록 펼치기";
    });
  });
</script>
{% endblock script %}






<style>
/* 추가 스타일들 */
.profile-name {
  font-size: 18px;
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 20px;
}

/* 카드 hover 효과 */
body .mypage-container .recommendation-card:hover {
  transform: translateY(-3px) !important;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

.recommendation-date {
  font-size: 12px;
  color: #718096;
  margin-bottom: 10px;
}

.favorites-section .recommendation-card {
  border: 2px solid #ffd700;
}

.favorites-section .recommendation-card:hover {
  box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
}

.remove-favorite {
  background: #4a90e2;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 15px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.remove-favorite:hover {
  background: #357abd;
  transform: scale(1.05);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.like-dislike-container {
  margin-top: 30px;
}

.likes-section,
.dislikes-section {
  margin-bottom: 30px;
}

.likes-section h3,
.dislikes-section h3 {
  font-size: 18px;
  margin-bottom: 15px;
  color: #2d3748;
}

/* 추천 받은 향수 내역 표 전용 hover 효과만 */
.recommendations-section .rec-list-wrap .rec-list li:hover {
  background: #f8fafc;
}

/* 비어 있는 메시지 일관성 */
.empty-message {
  text-align: center;
  color: #718096;
  font-style: italic;
  padding: 20px 10px;
}

/* [FIX] 선호/비선호 영역만 2열 고정 */
.likes-section .recommendations-grid,
.dislikes-section .recommendations-grid { 
  display: grid !important;
  grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
  gap: 16px !important;
}

/* [FIX] 카드 내 버튼 모양/정렬 복구 */
.recommendation-card .feedback-btn{
  display:inline-flex !important;
  align-items:center !important;
  justify-content:center !important;
  min-width: 56px !important;
  height: 32px !important;
  padding: 0 12px !important;
  border-radius: 16px !important;
  border: 1px solid #e2e8f0 !important;
  background:#f7fafc !important;
  color:#4a5568 !important;
  font-weight:600 !important;
  font-size:13px !important;
  cursor:pointer !important;
}

/* 활성 상태 색만 지정 (나머지는 그대로) */
.recommendation-card .like-btn.active{
  background:#4a90e2 !important; color:#fff !important; border:none !important;
}
.recommendation-card .dislike-btn.active{
  background:#e74c3c !important; color:#fff !important; border:none !important;
}


</style>